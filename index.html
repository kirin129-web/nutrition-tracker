<!DOCTYPE html>
<!-- v2: ç›®æ¨™è¨­å®šãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ»å˜ä½å…¥åŠ›è¿½åŠ  -->
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>1æ—¥ã®æ „é¤Šç´ ãƒã‚§ãƒƒã‚«ãƒ¼</title>

  <!-- ===== PWAå¯¾å¿œ ===== -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#27ae60">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="æ „é¤Šãƒã‚§ãƒƒã‚«ãƒ¼">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <!-- OGPï¼ˆSNSã‚·ã‚§ã‚¢ç”¨ï¼‰ -->
  <meta property="og:title" content="1æ—¥ã®æ „é¤Šç´ ãƒã‚§ãƒƒã‚«ãƒ¼">
  <meta property="og:description" content="çŒ®ç«‹ã‚’å…¥åŠ›ã—ã¦ä¸è¶³æ „é¤Šç´ ã‚’å¯è¦–åŒ–ã€‚é£Ÿäº‹æ‘‚å–åŸºæº–(2025å¹´ç‰ˆ)æº–æ‹ ã€‚">
  <meta property="og:type" content="website">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      padding: 20px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    header h1 { font-size: 1.4rem; font-weight: 700; }
    header p { font-size: 0.8rem; opacity: 0.85; margin-top: 4px; }

    .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š */
    .profile-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 20px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .profile-card label { font-size: 0.85rem; font-weight: 600; color: #555; }
    .profile-card select {
      margin-left: 8px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.85rem;
      background: #fafafa;
    }

    /* é£Ÿäº‹å…¥åŠ› */
    .meals-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 20px;
    }
    .meals-section h2 { font-size: 1rem; font-weight: 700; margin-bottom: 16px; color: #2ecc71; }
    .meal-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .meal-tab {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid #e0e0e0;
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .meal-tab.active {
      background: #2ecc71;
      border-color: #2ecc71;
      color: white;
    }
    .meal-inputs { display: flex; flex-direction: column; gap: 12px; }
    .food-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .food-row input[type="text"] {
      flex: 1;
      min-width: 140px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .food-row input[type="number"] {
      width: 80px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .food-row .unit { font-size: 0.8rem; color: #888; }
    .food-row .remove-btn {
      background: #fee;
      color: #e74c3c;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .add-food-btn {
      background: #f0fff4;
      color: #27ae60;
      border: 2px dashed #27ae60;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      width: 100%;
      margin-top: 8px;
    }
    .add-food-btn:hover { background: #e6ffe9; }
    .analyze-btn {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 32px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
      transition: opacity 0.2s;
      box-shadow: 0 4px 12px rgba(46,204,113,0.3);
    }
    .analyze-btn:hover { opacity: 0.9; }

    /* ===== ç›®æ¨™è¨­å®š ===== */
    .goal-card {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 20px;
    }
    .goal-card h2 { font-size: 1rem; font-weight: 700; margin-bottom: 12px; color: #8e44ad; }
    .goal-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .goal-tab {
      padding: 7px 14px;
      border-radius: 20px;
      border: 2px solid #e0e0e0;
      background: white;
      cursor: pointer;
      font-size: 0.82rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .goal-tab.active {
      background: #8e44ad;
      border-color: #8e44ad;
      color: white;
    }

    /* ===== ã‚ˆãä½¿ã†çŒ®ç«‹ ===== */
    .preset-bar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .preset-bar-label { font-size: 0.8rem; font-weight: 700; color: #888; white-space: nowrap; }
    .preset-chip {
      background: #f0f4ff;
      color: #3455db;
      border: 1.5px solid #c5d0f5;
      border-radius: 16px;
      padding: 5px 12px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .preset-chip:hover { background: #3455db; color: white; border-color: #3455db; }
    .preset-save-btn {
      background: #fff3e0;
      color: #e67e22;
      border: 1.5px solid #f5cba7;
      border-radius: 16px;
      padding: 5px 12px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .preset-save-btn:hover { background: #e67e22; color: white; }
    .preset-delete-btn {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0 0 0 4px;
    }
    .preset-delete-btn:hover { color: #e74c3c; }

    /* ===== å˜ä½å…¥åŠ›ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ ===== */
    .food-row select.unit-select {
      width: 110px;
      padding: 8px 6px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.8rem;
      background: #fafafa;
      color: #555;
    }

    /* çµæœã‚¨ãƒªã‚¢ */
    #results { display: none; }
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media(max-width: 700px) { .results-grid { grid-template-columns: 1fr; } }

    .result-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .result-card h3 { font-size: 0.95rem; font-weight: 700; margin-bottom: 16px; color: #555; }

    /* å……è¶³ç‡ãƒãƒ¼ */
    .nutrient-bar-list { display: flex; flex-direction: column; gap: 10px; }
    .nutrient-bar-item { }
    .nutrient-bar-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }
    .nutrient-name { font-weight: 600; display: block; }
    .nutrient-effect { font-size: 0.72rem; color: #999; font-weight: 400; display: block; margin-top: 1px; }
    .nutrient-pct {
      font-weight: 700;
    }
    .pct-low { color: #e74c3c; }
    .pct-ok { color: #2ecc71; }
    .pct-over { color: #f39c12; }
    .bar-bg {
      background: #eee;
      border-radius: 6px;
      height: 10px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.6s ease;
    }
    .bar-low { background: #e74c3c; }
    .bar-ok { background: #2ecc71; }
    .bar-over { background: #f39c12; }

    /* ãŠã™ã™ã‚é£Ÿæ */
    .recommend-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 20px;
    }
    .recommend-section h2 { font-size: 1rem; font-weight: 700; margin-bottom: 16px; color: #e67e22; }
    .deficient-list { display: flex; flex-direction: column; gap: 16px; }
    .deficient-item {
      border-left: 4px solid #e74c3c;
      padding-left: 14px;
    }
    .deficient-item h4 { font-size: 0.9rem; font-weight: 700; color: #333; margin-bottom: 6px; }
    .deficient-item .tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .food-tag {
      background: #fff3e0;
      color: #e67e22;
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 0.78rem;
      font-weight: 600;
    }
    .chart-container { position: relative; height: 320px; }

    /* ã‚µãƒãƒªãƒ¼ãƒãƒƒã‚¸ */
    .summary-badges {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .badge {
      border-radius: 10px;
      padding: 14px 20px;
      flex: 1;
      min-width: 120px;
      text-align: center;
    }
    .badge-red { background: #fde8e8; }
    .badge-green { background: #e8fdf0; }
    .badge-orange { background: #fef3e2; }
    .badge .num { font-size: 1.6rem; font-weight: 800; }
    .badge-red .num { color: #e74c3c; }
    .badge-green .num { color: #27ae60; }
    .badge-orange .num { color: #e67e22; }
    .badge p { font-size: 0.75rem; color: #666; margin-top: 2px; }

    .source-note {
      font-size: 0.72rem;
      color: #aaa;
      text-align: right;
      margin-top: 8px;
    }
    .loading { text-align: center; padding: 24px; color: #888; font-size: 0.9rem; }

    /* ===== ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      animation: modalIn 0.2s ease;
    }
    @keyframes modalIn {
      from { transform: translateY(20px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .modal h3 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: #333;
    }
    .modal-checks {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .modal-check-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      font-size: 0.88rem;
      font-weight: 600;
    }
    .modal-check-label:has(input:checked) {
      border-color: #27ae60;
      background: #f0fff4;
    }
    .modal-check-label input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: #27ae60;
      cursor: pointer;
      flex-shrink: 0;
    }
    .modal-check-label .check-icon { font-size: 1.1rem; }
    .modal-check-label .check-desc {
      font-size: 0.75rem;
      font-weight: 400;
      color: #888;
      margin-top: 2px;
    }
    .modal-actions {
      display: flex;
      gap: 8px;
    }
    .modal-btn {
      flex: 1;
      padding: 11px;
      border-radius: 10px;
      border: none;
      font-size: 0.88rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .modal-btn:hover { opacity: 0.85; }
    .modal-btn-cancel {
      background: #f0f0f0;
      color: #666;
    }
    .modal-btn-copy {
      background: #3498db;
      color: white;
    }
    .modal-btn-save {
      background: #27ae60;
      color: white;
    }
    .modal-toast {
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      display: none;
      text-align: center;
    }
    .modal-toast.success {
      background: #e8fdf0;
      color: #27ae60;
      display: block;
    }

    /* åˆ†æå¾Œã®ä¿å­˜ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .save-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .save-bar-btn {
      flex: 1;
      min-width: 140px;
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      font-size: 0.88rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: opacity 0.2s, transform 0.1s;
    }
    .save-bar-btn:hover { opacity: 0.88; }
    .save-bar-btn:active { transform: scale(0.97); }
    .save-bar-btn-copy { background: #ebf5fb; color: #2980b9; }
    .save-bar-btn-dl   { background: #eafaf1; color: #1e8449; }

    /* ===== ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ ===== */
    .chat-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .chat-header {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
    }
    .chat-header h2 { font-size: 0.95rem; font-weight: 700; flex: 1; }
    .chat-toggle-icon { font-size: 0.8rem; transition: transform 0.3s; }
    .chat-toggle-icon.open { transform: rotate(180deg); }
    .chat-body { display: none; flex-direction: column; height: 380px; }
    .chat-body.open { display: flex; }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f9fafb;
    }
    .chat-msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 0.85rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .chat-msg.bot {
      background: white;
      border: 1px solid #e0e0e0;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .chat-msg.user {
      background: #3498db;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .chat-msg .msg-label {
      font-size: 0.72rem;
      font-weight: 700;
      margin-bottom: 4px;
      opacity: 0.7;
    }
    .chat-suggestions {
      padding: 8px 12px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      background: #f0f4f8;
      border-top: 1px solid #e8e8e8;
    }
    .suggestion-chip {
      background: white;
      border: 1px solid #3498db;
      color: #3498db;
      border-radius: 16px;
      padding: 4px 12px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .suggestion-chip:hover { background: #3498db; color: white; }
    .chat-input-row {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: white;
    }
    .chat-input-row input {
      flex: 1;
      padding: 9px 14px;
      border: 1.5px solid #ddd;
      border-radius: 20px;
      font-size: 0.88rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .chat-input-row input:focus { border-color: #3498db; }
    .chat-send-btn {
      background: #3498db;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 9px 18px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .chat-send-btn:hover { opacity: 0.85; }
  </style>
</head>
<body>

<!-- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ï¼ˆAndroidã§è‡ªå‹•è¡¨ç¤ºï¼‰ -->
<div id="installBanner" style="display:none; background:#1a8a48; color:white; padding:12px 20px; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between;">
  <span style="font-size:0.88rem;">ğŸ“² ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ãˆã¾ã™ï¼</span>
  <div style="display:flex;gap:8px;">
    <button onclick="installApp()" style="background:white;color:#1a8a48;border:none;border-radius:6px;padding:6px 16px;font-weight:700;cursor:pointer;font-size:0.85rem;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
    <button onclick="document.getElementById('installBanner').style.display='none'" style="background:transparent;color:white;border:1px solid rgba(255,255,255,0.5);border-radius:6px;padding:6px 12px;cursor:pointer;font-size:0.85rem;">å¾Œã§</button>
  </div>
</div>

<header>
  <h1>ğŸ¥— 1æ—¥ã®æ „é¤Šç´ ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
  <p>çŒ®ç«‹ã‚’å…¥åŠ›ã—ã¦ã€ä¸è¶³æ „é¤Šç´ ã‚’å¯è¦–åŒ– ï¼ åšç”ŸåŠ´åƒçœã€Œæ—¥æœ¬äººã®é£Ÿäº‹æ‘‚å–åŸºæº–(2025å¹´ç‰ˆ)ã€æº–æ‹ </p>
</header>

<div class="container">

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
  <div class="profile-card">
    <div>
      <label>æ€§åˆ¥
        <select id="sex">
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
        </select>
      </label>
    </div>
    <div>
      <label>å¹´é½¢å±¤
        <select id="ageGroup">
          <option value="18-29">18ã€œ29æ­³</option>
          <option value="30-49">30ã€œ49æ­³</option>
          <option value="50-64">50ã€œ64æ­³</option>
          <option value="65-74">65ã€œ74æ­³</option>
        </select>
      </label>
    </div>
    <div>
      <label>èº«ä½“æ´»å‹•ãƒ¬ãƒ™ãƒ«
        <select id="activity">
          <option value="low">ä½ã„ï¼ˆãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯ä¸­å¿ƒï¼‰</option>
          <option value="mid" selected>ãµã¤ã†ï¼ˆé©åº¦ãªé‹å‹•ã‚ã‚Šï¼‰</option>
          <option value="high">é«˜ã„ï¼ˆæ´»ç™ºãªé‹å‹•ç¿’æ…£ã‚ã‚Šï¼‰</option>
        </select>
      </label>
    </div>
  </div>

  <!-- ç›®æ¨™è¨­å®š -->
  <div class="goal-card">
    <h2>ğŸ¯ ç›®æ¨™è¨­å®š</h2>
    <div class="goal-tabs">
      <button class="goal-tab active" onclick="setGoal('normal', this)">ğŸ½ é€šå¸¸</button>
      <button class="goal-tab" onclick="setGoal('diet', this)">âš–ï¸ ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ</button>
      <button class="goal-tab" onclick="setGoal('muscle', this)">ğŸ’ª ç­‹ãƒˆãƒ¬ãƒ»å¢—é‡</button>
      <button class="goal-tab" onclick="setGoal('beauty', this)">âœ¨ ç¾è‚Œãƒ»ç¾å®¹</button>
      <button class="goal-tab" onclick="setGoal('health', this)">ğŸ›¡ å…ç–«ãƒ»å¥åº·ç¶­æŒ</button>
      <button class="goal-tab" onclick="setGoal('energy', this)">âš¡ ç–²åŠ´å›å¾©</button>
    </div>
  </div>

  <!-- é£Ÿäº‹å…¥åŠ› -->
  <div class="meals-section">
    <h2>ğŸ“ ä»Šæ—¥ã®çŒ®ç«‹ã‚’å…¥åŠ›</h2>

    <!-- ã‚ˆãä½¿ã†çŒ®ç«‹ -->
    <div class="preset-bar" id="presetBar">
      <span class="preset-bar-label">â­ ã‚ˆãä½¿ã†ï¼š</span>
      <span id="presetChips"></span>
      <button class="preset-save-btn" onclick="savePreset()">ï¼‹ ä»Šã®çŒ®ç«‹ã‚’ä¿å­˜</button>
    </div>

    <div class="meal-tabs">
      <button class="meal-tab active" onclick="switchMeal('breakfast')">â˜€ï¸ æœé£Ÿ</button>
      <button class="meal-tab" onclick="switchMeal('lunch')">ğŸŒ¤ æ˜¼é£Ÿ</button>
      <button class="meal-tab" onclick="switchMeal('dinner')">ğŸŒ™ å¤•é£Ÿ</button>
      <button class="meal-tab" onclick="switchMeal('snack')">ğŸµ é–“é£Ÿ</button>
    </div>
    <div id="mealInputArea" class="meal-inputs"></div>
    <button class="add-food-btn" onclick="addFoodRow()">ï¼‹ é£Ÿæã‚’è¿½åŠ </button>
    <button class="analyze-btn" onclick="analyzeNutrition()">ğŸ“Š æ „é¤Šç´ ã‚’åˆ†æã™ã‚‹</button>
  </div>

  <!-- çµæœ -->
  <div id="results">

    <!-- ä¿å­˜ãƒãƒ¼ -->
    <div class="save-bar">
      <button class="save-bar-btn save-bar-btn-copy" onclick="openSaveModal('copy')">
        ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      </button>
      <button class="save-bar-btn save-bar-btn-dl" onclick="openSaveModal('download')">
        ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆã§ä¿å­˜
      </button>
    </div>

    <div class="summary-badges" id="summaryBadges"></div>

    <div class="results-grid">
      <div class="result-card">
        <h3>ğŸ“Š æ „é¤Šç´ å……è¶³ç‡ï¼ˆãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼‰</h3>
        <div class="chart-container">
          <canvas id="radarChart"></canvas>
        </div>
      </div>
      <div class="result-card">
        <h3>ğŸ“ˆ å„æ „é¤Šç´ ã®å……è¶³çŠ¶æ³</h3>
        <div id="nutrientBars" class="nutrient-bar-list"></div>
      </div>
    </div>

    <div class="recommend-section" id="recommendSection">
      <h2>ğŸ½ ä¸è¶³æ „é¤Šç´ ã‚’è£œã†ãŠã™ã™ã‚é£Ÿæ</h2>
      <div id="deficientList" class="deficient-list"></div>
    </div>

    <p class="source-note">â€» æ¨å¥¨é‡ã¯åšç”ŸåŠ´åƒçœã€Œæ—¥æœ¬äººã®é£Ÿäº‹æ‘‚å–åŸºæº–(2025å¹´ç‰ˆ)ã€ã«åŸºã¥ãã¾ã™ã€‚æ „é¤Šç´ è¨ˆç®—ã¯æ–‡éƒ¨ç§‘å­¦çœã€Œæ—¥æœ¬é£Ÿå“æ¨™æº–æˆåˆ†è¡¨(2023å¹´ç‰ˆ)ã€å‚è€ƒå€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
  </div>

  <!-- ===== æ „é¤Šãƒ»é£Ÿæãƒãƒ£ãƒƒãƒˆ ===== -->
  <div class="chat-section">
    <div class="chat-header" onclick="toggleChat()">
      <span style="font-size:1.2rem">ğŸ¤–</span>
      <h2>æ „é¤Šãƒ»é£Ÿæãªã‚“ã§ã‚‚è³ªå•</h2>
      <span class="chat-toggle-icon open" id="chatToggleIcon">â–²</span>
    </div>
    <div class="chat-body open" id="chatBody">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg bot">
          <div class="msg-label">ğŸ¤– æ „é¤Šã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
          ã“ã‚“ã«ã¡ã¯ï¼é£Ÿæã®é‡ã•ã‚„æ „é¤Šç´ ã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ğŸ˜Š<br><br>
          ä¾‹ãˆã°â€¦<br>
          ãƒ»ã€Œç´è±†1ãƒ‘ãƒƒã‚¯ã¯ä½•gï¼Ÿã€<br>
          ãƒ»ã€Œãƒ“ã‚¿ãƒŸãƒ³CãŒå¤šã„é£Ÿæã¯ï¼Ÿã€<br>
          ãƒ»ã€Œåµã®ã‚«ãƒ­ãƒªãƒ¼ã¯ï¼Ÿã€
        </div>
      </div>
      <div class="chat-suggestions" id="chatSuggestions">
        <span class="suggestion-chip" onclick="sendSuggestion(this)">ç´è±†1ãƒ‘ãƒƒã‚¯ã¯ä½•gï¼Ÿ</span>
        <span class="suggestion-chip" onclick="sendSuggestion(this)">åµ1å€‹ã¯ä½•gï¼Ÿ</span>
        <span class="suggestion-chip" onclick="sendSuggestion(this)">ã”é£¯1è†³ã¯ä½•gï¼Ÿ</span>
        <span class="suggestion-chip" onclick="sendSuggestion(this)">é‰„åˆ†ãŒå¤šã„é£Ÿæã¯ï¼Ÿ</span>
        <span class="suggestion-chip" onclick="sendSuggestion(this)">ãƒ“ã‚¿ãƒŸãƒ³CãŒå¤šã„é£Ÿæã¯ï¼Ÿ</span>
        <span class="suggestion-chip" onclick="sendSuggestion(this)">é£Ÿç‰©ç¹Šç¶­ãŒå¤šã„é£Ÿæã¯ï¼Ÿ</span>
        <span class="suggestion-chip" onclick="sendSuggestion(this)">ã‚«ãƒ«ã‚·ã‚¦ãƒ ãŒå¤šã„é£Ÿæã¯ï¼Ÿ</span>
        <span class="suggestion-chip" onclick="sendSuggestion(this)">ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãŒå¤šã„é£Ÿæã¯ï¼Ÿ</span>
      </div>
      <div class="chat-input-row">
        <input type="text" id="chatInput" placeholder="è³ªå•ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒãƒŠãƒŠ1æœ¬ã¯ä½•gï¼Ÿï¼‰" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="chat-send-btn" onclick="sendChat()">é€ä¿¡</button>
      </div>
    </div>
  </div>

</div>

<!-- ===== ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal-overlay" id="saveModal">
  <div class="modal">
    <h3>ğŸ“¤ ä¿å­˜ã™ã‚‹å†…å®¹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
    <div class="modal-checks">
      <label class="modal-check-label">
        <input type="checkbox" id="chk-menu" checked>
        <span class="check-icon">ğŸ½</span>
        <div>
          <div>ä»Šæ—¥ã®çŒ®ç«‹</div>
          <div class="check-desc">æœé£Ÿãƒ»æ˜¼é£Ÿãƒ»å¤•é£Ÿãƒ»é–“é£Ÿã®é£Ÿæã¨é‡</div>
        </div>
      </label>
      <label class="modal-check-label">
        <input type="checkbox" id="chk-result" checked>
        <span class="check-icon">ğŸ“Š</span>
        <div>
          <div>æ „é¤Šç´ åˆ†æçµæœ</div>
          <div class="check-desc">å„æ „é¤Šç´ ã®å……è¶³ç‡ãƒ»æ‘‚å–é‡ãƒ»ç›®æ¨™é‡</div>
        </div>
      </label>
      <label class="modal-check-label">
        <input type="checkbox" id="chk-recommend" checked>
        <span class="check-icon">ğŸ¥—</span>
        <div>
          <div>ãŠã™ã™ã‚é£Ÿæ</div>
          <div class="check-desc">ä¸è¶³æ „é¤Šç´ ã‚’è£œã†ãŸã‚ã®é£Ÿæãƒªã‚¹ãƒˆ</div>
        </div>
      </label>
    </div>
    <div class="modal-actions" id="modalActions"></div>
    <div class="modal-toast" id="modalToast"></div>
  </div>
</div>

<script>
// =====================================================
// 1æ—¥æ¨å¥¨æ‘‚å–é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¥æœ¬äººã®é£Ÿäº‹æ‘‚å–åŸºæº–2025å¹´ç‰ˆï¼‰
// =====================================================
const DRI = {
  male: {
    "18-29": { energy: 2650, protein: 65, fat: 74, carb: 370, fiber: 21, vitA: 900, vitD: 8.5, vitE: 6.0, vitK: 150, vitB1: 1.4, vitB2: 1.6, vitB6: 1.4, vitB12: 2.4, vitC: 100, folate: 240, calcium: 800, iron: 7.5, zinc: 11, magnesium: 340, potassium: 2500, sodium_max: 7500 },
    "30-49": { energy: 2700, protein: 65, fat: 75, carb: 375, fiber: 21, vitA: 900, vitD: 8.5, vitE: 6.0, vitK: 150, vitB1: 1.4, vitB2: 1.6, vitB6: 1.4, vitB12: 2.4, vitC: 100, folate: 240, calcium: 750, iron: 7.5, zinc: 11, magnesium: 370, potassium: 2500, sodium_max: 7500 },
    "50-64": { energy: 2600, protein: 65, fat: 72, carb: 360, fiber: 21, vitA: 900, vitD: 8.5, vitE: 7.0, vitK: 150, vitB1: 1.3, vitB2: 1.5, vitB6: 1.4, vitB12: 2.4, vitC: 100, folate: 240, calcium: 750, iron: 7.5, zinc: 11, magnesium: 370, potassium: 2500, sodium_max: 7500 },
    "65-74": { energy: 2400, protein: 60, fat: 67, carb: 335, fiber: 20, vitA: 850, vitD: 8.5, vitE: 7.0, vitK: 150, vitB1: 1.2, vitB2: 1.4, vitB6: 1.4, vitB12: 2.4, vitC: 100, folate: 240, calcium: 750, iron: 7.5, zinc: 10, magnesium: 350, potassium: 2500, sodium_max: 7500 },
  },
  female: {
    "18-29": { energy: 2000, protein: 50, fat: 56, carb: 280, fiber: 18, vitA: 700, vitD: 8.5, vitE: 5.0, vitK: 150, vitB1: 1.1, vitB2: 1.2, vitB6: 1.1, vitB12: 2.4, vitC: 100, folate: 240, calcium: 650, iron: 10.5, zinc: 8, magnesium: 270, potassium: 2000, sodium_max: 6500 },
    "30-49": { energy: 2050, protein: 50, fat: 57, carb: 285, fiber: 18, vitA: 700, vitD: 8.5, vitE: 5.5, vitK: 150, vitB1: 1.1, vitB2: 1.2, vitB6: 1.1, vitB12: 2.4, vitC: 100, folate: 240, calcium: 650, iron: 10.5, zinc: 8, magnesium: 290, potassium: 2000, sodium_max: 6500 },
    "50-64": { energy: 1950, protein: 50, fat: 54, carb: 270, fiber: 18, vitA: 700, vitD: 8.5, vitE: 6.0, vitK: 150, vitB1: 1.1, vitB2: 1.2, vitB6: 1.1, vitB12: 2.4, vitC: 100, folate: 240, calcium: 650, iron: 11.0, zinc: 8, magnesium: 290, potassium: 2000, sodium_max: 6500 },
    "65-74": { energy: 1850, protein: 50, fat: 52, carb: 258, fiber: 17, vitA: 700, vitD: 8.5, vitE: 6.5, vitK: 150, vitB1: 1.0, vitB2: 1.1, vitB6: 1.1, vitB12: 2.4, vitC: 100, folate: 240, calcium: 650, iron: 11.0, zinc: 8, magnesium: 280, potassium: 2000, sodium_max: 6500 },
  }
};

// æ´»å‹•ãƒ¬ãƒ™ãƒ«è£œæ­£ä¿‚æ•°
const ACTIVITY_FACTOR = { low: 0.85, mid: 1.0, high: 1.2 };

// æ „é¤Šç´ è¡¨ç¤ºåã¨å˜ä½
const NUTRIENT_META = {
  energy:    { label: 'ã‚¨ãƒãƒ«ã‚®ãƒ¼', unit: 'kcal',  icon: 'âš¡', effect: 'æ´»å‹•ãƒ»ä½“æ¸©ç¶­æŒã®åŸºæœ¬ã‚¨ãƒãƒ«ã‚®ãƒ¼æº' },
  protein:   { label: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ª', unit: 'g',     icon: 'ğŸ¥©', effect: 'ç­‹è‚‰ãƒ»è‚Œãƒ»é«ªãƒ»å…ç–«ã®ææ–™' },
  fat:       { label: 'è„‚è³ª',       unit: 'g',     icon: 'ğŸ§ˆ', effect: 'ãƒ›ãƒ«ãƒ¢ãƒ³ç”Ÿæˆãƒ»è„‚æº¶æ€§ãƒ“ã‚¿ãƒŸãƒ³å¸å' },
  carb:      { label: 'ç‚­æ°´åŒ–ç‰©',   unit: 'g',     icon: 'ğŸš', effect: 'è„³ãƒ»ç­‹è‚‰ã¸ã®å³åŠ¹ã‚¨ãƒãƒ«ã‚®ãƒ¼' },
  fiber:     { label: 'é£Ÿç‰©ç¹Šç¶­',   unit: 'g',     icon: 'ğŸ¥¦', effect: 'è…¸å†…ç’°å¢ƒæ”¹å–„ãƒ»è¡€ç³–å€¤ã®å®‰å®š' },
  vitA:      { label: 'ãƒ“ã‚¿ãƒŸãƒ³A',  unit: 'Î¼gRAE', icon: 'ğŸ¥•', effect: 'ç›®ã®å¥åº·ãƒ»è‚Œè’ã‚Œãƒ»ãƒ‹ã‚­ãƒ“æ”¹å–„' },
  vitD:      { label: 'ãƒ“ã‚¿ãƒŸãƒ³D',  unit: 'Î¼g',    icon: 'â˜€ï¸', effect: 'éª¨ã®å¼·åŒ–ãƒ»å…ç–«åŠ›ã‚¢ãƒƒãƒ—ãƒ»æ°—åˆ†å®‰å®š' },
  vitE:      { label: 'ãƒ“ã‚¿ãƒŸãƒ³E',  unit: 'mg',    icon: 'ğŸŒ¿', effect: 'æŠ—é…¸åŒ–ãƒ»è€åŒ–é˜²æ­¢ãƒ»è¡€è¡Œä¿ƒé€²' },
  vitK:      { label: 'ãƒ“ã‚¿ãƒŸãƒ³K',  unit: 'Î¼g',    icon: 'ğŸ¥¬', effect: 'éª¨å¯†åº¦ç¶­æŒãƒ»è¡€æ¶²å‡å›ºã®ã‚µãƒãƒ¼ãƒˆ' },
  vitB1:     { label: 'ãƒ“ã‚¿ãƒŸãƒ³B1', unit: 'mg',    icon: 'ğŸŒ¾', effect: 'ç³–è³ªã‚’ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«å¤‰æ›ãƒ»ç–²åŠ´å›å¾©' },
  vitB2:     { label: 'ãƒ“ã‚¿ãƒŸãƒ³B2', unit: 'mg',    icon: 'ğŸ¥›', effect: 'è‚Œãƒ»å£å†…ç‚äºˆé˜²ãƒ»ç´°èƒã®å†ç”Ÿä¿ƒé€²' },
  vitB6:     { label: 'ãƒ“ã‚¿ãƒŸãƒ³B6', unit: 'mg',    icon: 'ğŸŸ', effect: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ªä»£è¬ãƒ»ã‚¤ãƒ©ã‚¤ãƒ©ãƒ»PMSæ”¹å–„' },
  vitB12:    { label: 'ãƒ“ã‚¿ãƒŸãƒ³B12',unit: 'Î¼g',    icon: 'ğŸ¦ª', effect: 'è²§è¡€äºˆé˜²ãƒ»ç¥çµŒæ©Ÿèƒ½ãƒ»é›†ä¸­åŠ›ç¶­æŒ' },
  vitC:      { label: 'ãƒ“ã‚¿ãƒŸãƒ³C',  unit: 'mg',    icon: 'ğŸŠ', effect: 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³ç”Ÿæˆãƒ»ç¾è‚Œãƒ»å…ç–«å¼·åŒ–' },
  folate:    { label: 'è‘‰é…¸',       unit: 'Î¼g',    icon: 'ğŸ¥‘', effect: 'ç´°èƒåˆ†è£‚ãƒ»è²§è¡€äºˆé˜²ãƒ»å¦Šå¨ æœŸã«é‡è¦' },
  calcium:   { label: 'ã‚«ãƒ«ã‚·ã‚¦ãƒ ', unit: 'mg',    icon: 'ğŸ¥›', effect: 'éª¨ãƒ»æ­¯ã®å½¢æˆãƒ»ç­‹è‚‰åç¸®ãƒ»ç²¾ç¥å®‰å®š' },
  iron:      { label: 'é‰„',         unit: 'mg',    icon: 'ğŸ«€', effect: 'è²§è¡€äºˆé˜²ãƒ»ç–²ã‚Œã«ãã„ä½“ãƒ»é›†ä¸­åŠ›å‘ä¸Š' },
  zinc:      { label: 'äºœé‰›',       unit: 'mg',    icon: 'ğŸ¦', effect: 'å…ç–«å¼·åŒ–ãƒ»å‘³è¦šæ­£å¸¸ãƒ»è‚Œã®æ–°é™³ä»£è¬' },
  magnesium: { label: 'ãƒã‚°ãƒã‚·ã‚¦ãƒ ',unit: 'mg',   icon: 'ğŸŒ°', effect: 'ç­‹è‚‰ç–²åŠ´å›å¾©ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ç·©å’Œãƒ»ä¾¿ç§˜æ”¹å–„' },
  potassium: { label: 'ã‚«ãƒªã‚¦ãƒ ',   unit: 'mg',    icon: 'ğŸŒ', effect: 'ã‚€ãã¿è§£æ¶ˆãƒ»è¡€åœ§ä½ä¸‹ãƒ»ç­‹è‚‰ã®æ­£å¸¸åŒ–' },
};

// ä¸è¶³æ™‚ã®ãŠã™ã™ã‚é£Ÿæ
const FOOD_RECOMMENDATIONS = {
  energy:    ['ã”é£¯', 'ãƒ‘ãƒ³', 'ãƒ‘ã‚¹ã‚¿', 'ã˜ã‚ƒãŒã„ã‚‚', 'ãƒãƒŠãƒŠ'],
  protein:   ['é¶ã‚€ã­è‚‰', 'è±†è…', 'åµ', 'é®­', 'ã‚®ãƒªã‚·ãƒ£ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ', 'ç´è±†'],
  fat:       ['ã‚¢ãƒœã‚«ãƒ‰', 'ãã‚‹ã¿', 'ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«', 'ã‚µãƒ¼ãƒ¢ãƒ³', 'äºœéº»ä»æ²¹'],
  carb:      ['ç™½ç±³', 'ã•ã¤ã¾ã„ã‚‚', 'ãã°', 'å…¨ç²’ç²‰ãƒ‘ãƒ³', 'ãƒãƒŠãƒŠ'],
  fiber:     ['ã”ã¼ã†', 'ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«', 'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', 'ã‚­ã‚¦ã‚¤', 'ä¹¾ç‡¥ãƒ—ãƒ«ãƒ¼ãƒ³', 'æŠ¼ã—éº¦'],
  vitA:      ['ã«ã‚“ã˜ã‚“', 'ã‹ã¼ã¡ã‚ƒ', 'ã»ã†ã‚Œã‚“è‰', 'ã†ãªã', 'ãƒ¬ãƒãƒ¼', 'å°æ¾èœ'],
  vitD:      ['é®­', 'ã•ã‚“ã¾', 'ã—ã‚‰ã™', 'ãã®ã“é¡', 'ã„ã‚ã—', 'åµé»„'],
  vitE:      ['ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰', 'ã²ã¾ã‚ã‚Šæ²¹', 'ã‹ã¼ã¡ã‚ƒ', 'ã‚¢ãƒœã‚«ãƒ‰', 'æ¾ã®å®Ÿ'],
  vitK:      ['ç´è±†', 'ã»ã†ã‚Œã‚“è‰', 'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', 'å°æ¾èœ', 'ãƒ¢ãƒ­ãƒ˜ã‚¤ãƒ¤'],
  vitB1:     ['è±šè‚‰', 'ç„ç±³', 'æè±†', 'å¤§è±†', 'ã”ã¾', 'ã†ãªã'],
  vitB2:     ['ãƒ¬ãƒãƒ¼', 'ã†ãªã', 'åµ', 'ç‰›ä¹³', 'ã»ã†ã‚Œã‚“è‰', 'ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰'],
  vitB6:     ['ã¾ãã‚', 'é¶è‚‰', 'ãƒãƒŠãƒŠ', 'ã˜ã‚ƒãŒã„ã‚‚', 'ã”ã¾', 'ãƒ”ã‚¹ã‚¿ãƒã‚ª'],
  vitB12:    ['ã‚ã•ã‚Š', 'ã—ã˜ã¿', 'ã»ã£ã‘', 'ã•ã‚“ã¾', 'ç‰›ãƒ¬ãƒãƒ¼', 'åµ'],
  vitC:      ['èµ¤ãƒ‘ãƒ—ãƒªã‚«', 'ã‚­ã‚¦ã‚¤', 'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', 'ã„ã¡ã”', 'ã‚¢ã‚»ãƒ­ãƒ©', 'æŸ‘æ©˜é¡'],
  folate:    ['æè±†', 'ã»ã†ã‚Œã‚“è‰', 'ã‚¢ã‚¹ãƒ‘ãƒ©', 'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', 'å¤§è±†', 'ã„ã¡ã”'],
  calcium:   ['ç‰›ä¹³', 'ãƒãƒ¼ã‚º', 'è±†è…', 'ã²ã˜ã', 'å°æ¾èœ', 'ã—ã‚‰ã™', 'ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ'],
  iron:      ['ãƒ¬ãƒãƒ¼', 'ã‚ã•ã‚Š', 'ç´è±†', 'ã²ã˜ã', 'å°æ¾èœ', 'ãƒ—ãƒ«ãƒ¼ãƒ³', 'ç‰›èµ¤èº«è‚‰'],
  zinc:      ['ç‰¡è £', 'ç‰›èµ¤èº«è‚‰', 'ã‚«ã‚·ãƒ¥ãƒ¼ãƒŠãƒƒãƒ„', 'è±†è…', 'ã”ã¾', 'é«˜é‡è±†è…'],
  magnesium: ['è±†è…', 'ç„ç±³', 'ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰', 'ã»ã†ã‚Œã‚“è‰', 'ãƒãƒŠãƒŠ', 'ã‚ã‹ã‚', 'ã”ã¾'],
  potassium: ['ãƒãƒŠãƒŠ', 'ã‚¢ãƒœã‚«ãƒ‰', 'ã˜ã‚ƒãŒã„ã‚‚', 'ã»ã†ã‚Œã‚“è‰', 'ã²ã˜ã', 'è±†é¡'],
};

// =====================================================
// é£Ÿå“æ „é¤Šæˆåˆ†ãƒ‡ãƒ¼ã‚¿ï¼ˆ100gã‚ãŸã‚Šï¼‰
// =====================================================
const FOOD_DB = {
  // ä¸»é£Ÿ
  'ã”é£¯':        { energy:168, protein:2.5, fat:0.3, carb:37.1, fiber:0.3, vitA:0,   vitD:0,   vitE:0,   vitK:0,   vitB1:0.02, vitB2:0.01, vitB6:0.02, vitB12:0,    vitC:0,  folate:3,   calcium:3,   iron:0.1, zinc:0.6, magnesium:11,  potassium:29 },
  'é£Ÿãƒ‘ãƒ³':      { energy:248, protein:8.9, fat:4.1, carb:46.4, fiber:2.3, vitA:0,   vitD:0,   vitE:0.4, vitK:6,   vitB1:0.08, vitB2:0.06, vitB6:0.04, vitB12:0,    vitC:0,  folate:30,  calcium:22,  iron:0.5, zinc:0.8, magnesium:20,  potassium:97 },
  'ãƒ‘ã‚¹ã‚¿(èŒ¹ã§)':{ energy:150, protein:5.8, fat:0.9, carb:30.3, fiber:1.5, vitA:0,   vitD:0,   vitE:0.2, vitK:0,   vitB1:0.04, vitB2:0.02, vitB6:0.03, vitB12:0,    vitC:0,  folate:6,   calcium:8,   iron:0.7, zinc:0.7, magnesium:19,  potassium:56 },
  'ã†ã©ã‚“(èŒ¹ã§)': { energy:105, protein:2.6, fat:0.4, carb:22.0, fiber:0.8, vitA:0,   vitD:0,   vitE:0,   vitK:0,   vitB1:0.02, vitB2:0.01, vitB6:0.02, vitB12:0,    vitC:0,  folate:5,   calcium:7,   iron:0.2, zinc:0.2, magnesium:7,   potassium:9 },
  'ãã°(èŒ¹ã§)':  { energy:132, protein:4.8, fat:1.0, carb:26.0, fiber:2.0, vitA:0,   vitD:0,   vitE:0.3, vitK:0,   vitB1:0.06, vitB2:0.02, vitB6:0.05, vitB12:0,    vitC:0,  folate:13,  calcium:12,  iron:0.8, zinc:0.4, magnesium:27,  potassium:34 },
  'ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«': { energy:380, protein:13.7,fat:5.7, carb:69.1, fiber:9.4, vitA:0,   vitD:0,   vitE:0.6, vitK:0,   vitB1:0.20, vitB2:0.07, vitB6:0.10, vitB12:0,    vitC:0,  folate:30,  calcium:47,  iron:3.9, zinc:2.1, magnesium:100, potassium:260 },
  'ç„ç±³(ç‚Šã„ãŸ)':{ energy:165, protein:2.8, fat:1.0, carb:35.6, fiber:1.4, vitA:0,   vitD:0,   vitE:0.5, vitK:0,   vitB1:0.16, vitB2:0.02, vitB6:0.21, vitB12:0,    vitC:0,  folate:10,  calcium:7,   iron:0.6, zinc:0.8, magnesium:49,  potassium:95 },

  // è‚‰é¡
  'é¶ã‚€ã­è‚‰':    { energy:116, protein:23.3, fat:1.9, carb:0,   fiber:0,   vitA:8,   vitD:0.1, vitE:0.3, vitK:11,  vitB1:0.09, vitB2:0.10, vitB6:0.64, vitB12:0.2,  vitC:3,  folate:9,   calcium:3,   iron:0.3, zinc:0.7, magnesium:27,  potassium:340 },
  'é¶ã‚‚ã‚‚è‚‰':    { energy:190, protein:17.3, fat:14.2,carb:0,   fiber:0,   vitA:47,  vitD:0.1, vitE:0.4, vitK:60,  vitB1:0.10, vitB2:0.15, vitB6:0.25, vitB12:0.3,  vitC:3,  folate:13,  calcium:6,   iron:0.6, zinc:1.6, magnesium:20,  potassium:270 },
  'è±šãƒ­ãƒ¼ã‚¹':    { energy:248, protein:19.3, fat:19.2,carb:0.2, fiber:0,   vitA:4,   vitD:0.3, vitE:0.3, vitK:6,   vitB1:0.69, vitB2:0.19, vitB6:0.34, vitB12:0.5,  vitC:1,  folate:2,   calcium:3,   iron:0.5, zinc:2.0, magnesium:20,  potassium:310 },
  'è±šãƒãƒ©':      { energy:386, protein:14.4, fat:35.4,carb:0.1, fiber:0,   vitA:5,   vitD:0.3, vitE:0.8, vitK:3,   vitB1:0.54, vitB2:0.14, vitB6:0.25, vitB12:0.6,  vitC:1,  folate:2,   calcium:3,   iron:0.6, zinc:1.8, magnesium:15,  potassium:240 },
  'ç‰›ã²ãè‚‰':    { energy:224, protein:17.1, fat:21.1,carb:0.3, fiber:0,   vitA:2,   vitD:0.1, vitE:0.4, vitK:4,   vitB1:0.07, vitB2:0.17, vitB6:0.23, vitB12:1.7,  vitC:1,  folate:5,   calcium:6,   iron:2.1, zinc:4.0, magnesium:18,  potassium:290 },
  'ç‰›èµ¤èº«':      { energy:133, protein:22.0, fat:4.6, carb:0.3, fiber:0,   vitA:3,   vitD:0.1, vitE:0.3, vitK:5,   vitB1:0.08, vitB2:0.19, vitB6:0.32, vitB12:1.5,  vitC:1,  folate:7,   calcium:4,   iron:2.5, zinc:4.2, magnesium:22,  potassium:350 },
  'ãƒ¬ãƒãƒ¼(é¶)':  { energy:111, protein:18.9, fat:3.1, carb:0.6, fiber:0,   vitA:14000,vitD:0.2,vitE:1.0, vitK:0,   vitB1:0.38, vitB2:1.80, vitB6:0.65, vitB12:44.4, vitC:20, folate:1300,calcium:11,  iron:9.0, zinc:3.3, magnesium:19,  potassium:330 },

  // é­šä»‹é¡
  'é®­':          { energy:133, protein:22.3, fat:4.1, carb:0.1, fiber:0,   vitA:11,  vitD:32.0,vitE:1.2, vitK:1,   vitB1:0.15, vitB2:0.21, vitB6:0.64, vitB12:9.4,  vitC:0,  folate:28,  calcium:14,  iron:0.5, zinc:0.5, magnesium:28,  potassium:350 },
  'ã¾ãã‚(èµ¤èº«)':{ energy:125, protein:26.4, fat:1.4, carb:0.1, fiber:0,   vitA:83,  vitD:5.0, vitE:0.8, vitK:2,   vitB1:0.10, vitB2:0.05, vitB6:0.85, vitB12:1.3,  vitC:2,  folate:8,   calcium:5,   iron:1.1, zinc:0.4, magnesium:45,  potassium:380 },
  'ã•ã‚“ã¾':      { energy:297, protein:18.1, fat:25.6,carb:0.1, fiber:0,   vitA:13,  vitD:14.9,vitE:1.6, vitK:0,   vitB1:0.01, vitB2:0.28, vitB6:0.54, vitB12:17.7, vitC:0,  folate:11,  calcium:28,  iron:1.4, zinc:1.0, magnesium:28,  potassium:200 },
  'ã‚ã•ã‚Š':      { energy:30,  protein:6.0,  fat:0.3, carb:0.4, fiber:0,   vitA:4,   vitD:0.1, vitE:0.4, vitK:0,   vitB1:0.02, vitB2:0.16, vitB6:0.05, vitB12:52.4, vitC:1,  folate:11,  calcium:66,  iron:3.8, zinc:0.9, magnesium:100, potassium:140 },
  'ã†ãªã':      { energy:255, protein:17.1, fat:19.3,carb:3.1, fiber:0,   vitA:2400,vitD:18.0,vitE:7.4, vitK:10,  vitB1:0.75, vitB2:0.74, vitB6:0.21, vitB12:3.5,  vitC:2,  folate:13,  calcium:150, iron:0.8, zinc:1.4, magnesium:20,  potassium:230 },
  'ç‰¡è £':        { energy:58,  protein:6.9,  fat:1.4, carb:4.9, fiber:0,   vitA:23,  vitD:0.1, vitE:1.4, vitK:0,   vitB1:0.07, vitB2:0.14, vitB6:0.09, vitB12:28.4, vitC:4,  folate:39,  calcium:88,  iron:1.9, zinc:13.2,magnesium:65,  potassium:190 },

  // åµãƒ»ä¹³è£½å“
  'åµ':          { energy:151, protein:12.3, fat:10.3,carb:0.4, fiber:0,   vitA:140, vitD:1.8, vitE:1.0, vitK:12,  vitB1:0.06, vitB2:0.37, vitB6:0.08, vitB12:0.9,  vitC:0,  folate:49,  calcium:51,  iron:1.8, zinc:1.1, magnesium:10,  potassium:130 },
  'ç‰›ä¹³':        { energy:67,  protein:3.3,  fat:3.8, carb:4.8, fiber:0,   vitA:38,  vitD:0.3, vitE:0.1, vitK:0,   vitB1:0.04, vitB2:0.15, vitB6:0.03, vitB12:0.3,  vitC:1,  folate:5,   calcium:110, iron:0,   zinc:0.4, magnesium:10,  potassium:150 },
  'ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ':  { energy:62,  protein:3.6,  fat:3.0, carb:4.9, fiber:0,   vitA:33,  vitD:0.1, vitE:0.1, vitK:0,   vitB1:0.04, vitB2:0.14, vitB6:0.04, vitB12:0.6,  vitC:1,  folate:11,  calcium:120, iron:0.1, zinc:0.4, magnesium:12,  potassium:170 },
  'ãƒãƒ¼ã‚º(ã‚«ãƒãƒ³ãƒ™ãƒ¼ãƒ«)':{ energy:291, protein:19.1, fat:24.7,carb:0.9, fiber:0,   vitA:240, vitD:0.2, vitE:0.5, vitK:20,  vitB1:0.04, vitB2:0.48, vitB6:0.14, vitB12:1.3,  vitC:0,  folate:47,  calcium:460, iron:0.2, zinc:2.8, magnesium:20,  potassium:120 },

  // å¤§è±†è£½å“
  'è±†è…(æœ¨ç¶¿)':  { energy:72,  protein:6.6,  fat:4.2, carb:1.6, fiber:0.4, vitA:1,   vitD:0,   vitE:0.5, vitK:32,  vitB1:0.09, vitB2:0.04, vitB6:0.06, vitB12:0,    vitC:0,  folate:24,  calcium:93,  iron:1.5, zinc:0.6, magnesium:57,  potassium:110 },
  'ç´è±†':        { energy:200, protein:16.5, fat:10.0,carb:12.1,fiber:6.7, vitA:0,   vitD:0,   vitE:1.3, vitK:600, vitB1:0.07, vitB2:0.56, vitB6:0.24, vitB12:0,    vitC:0,  folate:120, calcium:90,  iron:3.3, zinc:1.9, magnesium:100, potassium:660 },
  'æè±†':        { energy:135, protein:11.5, fat:6.1, carb:8.8, fiber:5.0, vitA:27,  vitD:0,   vitE:0.8, vitK:29,  vitB1:0.31, vitB2:0.15, vitB6:0.15, vitB12:0,    vitC:27, folate:320, calcium:76,  iron:2.7, zinc:1.4, magnesium:62,  potassium:590 },

  // é‡èœé¡
  'ã»ã†ã‚Œã‚“è‰':  { energy:20,  protein:2.2,  fat:0.4, carb:3.1, fiber:2.8, vitA:350, vitD:0,   vitE:2.1, vitK:270, vitB1:0.11, vitB2:0.20, vitB6:0.14, vitB12:0,    vitC:35, folate:210, calcium:49,  iron:2.0, zinc:0.7, magnesium:69,  potassium:690 },
  'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼':{ energy:33,  protein:4.3,  fat:0.5, carb:5.2, fiber:4.4, vitA:67,  vitD:0,   vitE:2.4, vitK:120, vitB1:0.14, vitB2:0.20, vitB6:0.27, vitB12:0,    vitC:120,folate:210, calcium:38,  iron:1.0, zinc:0.6, magnesium:29,  potassium:360 },
  'å°æ¾èœ':      { energy:14,  protein:1.5,  fat:0.2, carb:2.4, fiber:1.9, vitA:260, vitD:0,   vitE:0.9, vitK:210, vitB1:0.09, vitB2:0.13, vitB6:0.11, vitB12:0,    vitC:39, folate:110, calcium:170, iron:2.8, zinc:0.3, magnesium:12,  potassium:500 },
  'ã«ã‚“ã˜ã‚“':    { energy:39,  protein:0.7,  fat:0.2, carb:9.3, fiber:2.8, vitA:690, vitD:0,   vitE:0.4, vitK:10,  vitB1:0.04, vitB2:0.03, vitB6:0.10, vitB12:0,    vitC:6,  folate:21,  calcium:28,  iron:0.2, zinc:0.2, magnesium:10,  potassium:280 },
  'ã‹ã¼ã¡ã‚ƒ':    { energy:91,  protein:1.9,  fat:0.3, carb:20.6,fiber:3.5, vitA:330, vitD:0,   vitE:4.9, vitK:17,  vitB1:0.07, vitB2:0.09, vitB6:0.17, vitB12:0,    vitC:43, folate:42,  calcium:15,  iron:0.5, zinc:0.3, magnesium:25,  potassium:480 },
  'ãƒˆãƒãƒˆ':      { energy:19,  protein:0.7,  fat:0.1, carb:4.7, fiber:1.0, vitA:45,  vitD:0,   vitE:0.9, vitK:4,   vitB1:0.05, vitB2:0.02, vitB6:0.08, vitB12:0,    vitC:15, folate:22,  calcium:7,   iron:0.2, zinc:0.1, magnesium:9,   potassium:210 },
  'ãƒ‘ãƒ—ãƒªã‚«(èµ¤)':{ energy:30,  protein:1.0,  fat:0.2, carb:7.2, fiber:1.6, vitA:88,  vitD:0,   vitE:4.3, vitK:4,   vitB1:0.06, vitB2:0.14, vitB6:0.37, vitB12:0,    vitC:170,folate:68,  calcium:7,   iron:0.4, zinc:0.2, magnesium:11,  potassium:210 },
  'ã”ã¼ã†':      { energy:65,  protein:1.8,  fat:0.1, carb:15.4,fiber:5.7, vitA:0,   vitD:0,   vitE:0.2, vitK:0,   vitB1:0.05, vitB2:0.04, vitB6:0.10, vitB12:0,    vitC:2,  folate:68,  calcium:46,  iron:0.7, zinc:0.8, magnesium:54,  potassium:320 },
  'ãã®ã“(ã—ã„ãŸã‘)':{ energy:25, protein:3.0, fat:0.3, carb:6.4, fiber:4.2, vitA:0, vitD:0.4, vitE:0,  vitK:0,   vitB1:0.10, vitB2:0.19, vitB6:0.17, vitB12:0,    vitC:2,  folate:49,  calcium:4,   iron:0.4, zinc:0.8, magnesium:15,  potassium:290 },

  // æœç‰©é¡
  'ãƒãƒŠãƒŠ':      { energy:86,  protein:1.1,  fat:0.2, carb:22.5,fiber:1.1, vitA:6,   vitD:0,   vitE:0.5, vitK:0,   vitB1:0.05, vitB2:0.04, vitB6:0.38, vitB12:0,    vitC:16, folate:26,  calcium:6,   iron:0.3, zinc:0.2, magnesium:32,  potassium:360 },
  'ã¿ã‹ã‚“':      { energy:46,  protein:0.7,  fat:0.1, carb:12.0,fiber:1.0, vitA:17,  vitD:0,   vitE:0.4, vitK:0,   vitB1:0.10, vitB2:0.03, vitB6:0.07, vitB12:0,    vitC:32, folate:22,  calcium:21,  iron:0.1, zinc:0.1, magnesium:11,  potassium:150 },
  'ã‚­ã‚¦ã‚¤':      { energy:53,  protein:1.0,  fat:0.2, carb:13.5,fiber:2.5, vitA:7,   vitD:0,   vitE:1.3, vitK:34,  vitB1:0.01, vitB2:0.02, vitB6:0.13, vitB12:0,    vitC:69, folate:37,  calcium:26,  iron:0.3, zinc:0.1, magnesium:14,  potassium:290 },
  'ã„ã¡ã”':      { energy:34,  protein:0.9,  fat:0.1, carb:8.5, fiber:1.4, vitA:0,   vitD:0,   vitE:0.4, vitK:4,   vitB1:0.03, vitB2:0.02, vitB6:0.05, vitB12:0,    vitC:62, folate:90,  calcium:17,  iron:0.3, zinc:0.2, magnesium:13,  potassium:170 },
  'ã‚¢ãƒœã‚«ãƒ‰':    { energy:187, protein:2.1,  fat:18.7,carb:6.2, fiber:5.6, vitA:7,   vitD:0,   vitE:3.3, vitK:20,  vitB1:0.10, vitB2:0.21, vitB6:0.32, vitB12:0,    vitC:12, folate:84,  calcium:9,   iron:0.6, zinc:0.7, magnesium:33,  potassium:720 },

  // ãƒŠãƒƒãƒ„ãƒ»ç¨®å­
  'ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰':  { energy:608, protein:19.6, fat:51.8,carb:19.7,fiber:10.1,vitA:0,   vitD:0,   vitE:30.3,vitK:0,   vitB1:0.20, vitB2:1.04, vitB6:0.09, vitB12:0,    vitC:0,  folate:64,  calcium:260, iron:3.7, zinc:3.6, magnesium:270, potassium:740 },
  'ãã‚‹ã¿':      { energy:713, protein:14.6, fat:68.8,carb:11.7,fiber:7.5, vitA:0,   vitD:0,   vitE:1.2, vitK:2,   vitB1:0.26, vitB2:0.15, vitB6:0.49, vitB12:0,    vitC:0,  folate:91,  calcium:85,  iron:2.6, zinc:2.6, magnesium:150, potassium:540 },

  // ãã®ä»–
  'ã²ã˜ã(ä¹¾)':  { energy:180, protein:9.2,  fat:1.5, carb:58.4,fiber:51.8,vitA:88,  vitD:0,   vitE:0.1, vitK:0,   vitB1:0,    vitB2:0,    vitB6:0,    vitB12:0,    vitC:0,  folate:93,  calcium:1000,iron:58.2,zinc:1.0, magnesium:640, potassium:4400 },
  'ã‚ã‹ã‚(ç”Ÿ)':  { energy:24,  protein:1.9,  fat:0.2, carb:5.8, fiber:3.6, vitA:98,  vitD:0,   vitE:1.0, vitK:190, vitB1:0.08, vitB2:0.14, vitB6:0.02, vitB12:0,    vitC:15, folate:49,  calcium:100, iron:0.7, zinc:0.3, magnesium:110, potassium:730 },
  'ã¿ãæ±(1æ¯)': { energy:30,  protein:2.0,  fat:1.0, carb:3.5, fiber:0.5, vitA:0,   vitD:0,   vitE:0.1, vitK:0,   vitB1:0.03, vitB2:0.02, vitB6:0.04, vitB12:0,    vitC:0,  folate:10,  calcium:30,  iron:0.7, zinc:0.5, magnesium:20,  potassium:210 },
  'ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°(å¤§ã•ã˜1)':{ energy:40, protein:0.2, fat:4.0, carb:1.5, fiber:0, vitA:0,vitD:0,vitE:0.5,vitK:0,vitB1:0,vitB2:0,vitB6:0,vitB12:0,vitC:0,folate:0,calcium:2,iron:0,zinc:0,magnesium:1,potassium:5 },
};

// =====================================================
// ã‚¢ãƒ—ãƒªçŠ¶æ…‹
// =====================================================
let currentMeal = 'breakfast';
let meals = {
  breakfast: [{ food: '', amount: 100 }],
  lunch:     [{ food: '', amount: 100 }],
  dinner:    [{ food: '', amount: 100 }],
  snack:     [{ food: '', amount: 100 }],
};
let radarChartInstance = null;

const MEAL_LABELS = { breakfast:'â˜€ï¸ æœé£Ÿ', lunch:'ğŸŒ¤ æ˜¼é£Ÿ', dinner:'ğŸŒ™ å¤•é£Ÿ', snack:'ğŸµ é–“é£Ÿ' };

function switchMeal(meal) {
  saveMealInputs();
  currentMeal = meal;
  const tabs = document.querySelectorAll('.meal-tab');
  const mealKeys = Object.keys(MEAL_LABELS);
  tabs.forEach((t, i) => { t.classList.toggle('active', mealKeys[i] === meal); });
  renderMealInputs();
}

function saveMealInputs() {
  const rows = document.querySelectorAll('#mealInputArea .food-row');
  meals[currentMeal] = Array.from(rows).map(row => ({
    food: row.querySelector('.food-name').value,
    amount: parseFloat(row.querySelector('.food-amount').value) || 0,
  }));
}

function renderMealInputs() {
  const area = document.getElementById('mealInputArea');
  area.innerHTML = '';
  const items = meals[currentMeal];
  items.forEach((item, i) => {
    area.appendChild(createFoodRow(item.food, item.amount));
  });
}

function createFoodRow(food = '', amount = 100) {
  const div = document.createElement('div');
  div.className = 'food-row';

  const datalistId = 'foodList_' + Math.random().toString(36).slice(2);
  const foodNames = Object.keys(FOOD_DB);

  // å˜ä½é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆFOOD_PORTIONSã«ã‚ã‚‹é£Ÿæã¯gä»¥å¤–ã‚‚é¸ã¹ã‚‹ï¼‰
  const portions = FOOD_PORTIONS[food] || [];
  const unitOptions = [
    `<option value="g" selected>g</option>`,
    ...portions.map(p => `<option value="${p.g}">${p.unit}(${p.g}g)</option>`)
  ].join('');

  div.innerHTML = `
    <input type="text" class="food-name" list="${datalistId}" placeholder="é£Ÿæåï¼ˆä¾‹ï¼šã”é£¯ï¼‰" value="${food}">
    <datalist id="${datalistId}">
      ${foodNames.map(n => `<option value="${n}">`).join('')}
    </datalist>
    <input type="number" class="food-amount" min="1" max="2000" value="${amount}">
    <select class="unit-select" onchange="onUnitChange(this)">
      ${unitOptions}
    </select>
    <button class="remove-btn" onclick="this.parentElement.remove()">âœ•</button>
  `;

  // é£ŸæåãŒå¤‰ã‚ã£ãŸã¨ãå˜ä½é¸æŠè‚¢ã‚’æ›´æ–°
  const nameInput = div.querySelector('.food-name');
  nameInput.addEventListener('change', () => updateUnitOptions(div));
  nameInput.addEventListener('input',  () => updateUnitOptions(div));

  return div;
}

function updateUnitOptions(row) {
  const food = row.querySelector('.food-name').value;
  const sel  = row.querySelector('.unit-select');
  const portions = FOOD_PORTIONS[food] || [];
  sel.innerHTML = [
    `<option value="g">g</option>`,
    ...portions.map(p => `<option value="${p.g}">${p.unit}(${p.g}g)</option>`)
  ].join('');
}

function onUnitChange(sel) {
  if (sel.value !== 'g') {
    sel.closest('.food-row').querySelector('.food-amount').value = sel.value;
  }
}

function addFoodRow() {
  document.getElementById('mealInputArea').appendChild(createFoodRow());
}

// =====================================================
// æ „é¤Šç´ è¨ˆç®—
// =====================================================
function calcNutrients() {
  saveMealInputs();
  const totals = {};
  Object.keys(NUTRIENT_META).forEach(k => totals[k] = 0);

  Object.values(meals).forEach(mealItems => {
    mealItems.forEach(({ food, amount }) => {
      if (!food || !amount) return;
      const db = FOOD_DB[food];
      if (!db) return;
      const ratio = amount / 100;
      Object.keys(NUTRIENT_META).forEach(k => {
        if (db[k] !== undefined) totals[k] += db[k] * ratio;
      });
    });
  });
  return totals;
}

function getTargets() {
  const sex = document.getElementById('sex').value;
  const age = document.getElementById('ageGroup').value;
  const act = document.getElementById('activity').value;
  const base = DRI[sex][age];
  const factor = ACTIVITY_FACTOR[act];
  const result = {};
  Object.keys(base).forEach(k => {
    result[k] = k === 'energy' ? Math.round(base[k] * factor) : base[k];
  });
  return result;
}

// =====================================================
// åˆ†æãƒ»è¡¨ç¤º
// =====================================================
function analyzeNutrition() {
  const totals = calcNutrients();
  const targets = getTargets();

  // å……è¶³ç‡è¨ˆç®—ï¼ˆ% of æ¨å¥¨é‡ï¼‰
  const rates = {};
  Object.keys(NUTRIENT_META).forEach(k => {
    const t = targets[k];
    if (!t) return;
    rates[k] = Math.round((totals[k] / t) * 100);
  });

  // ä¿å­˜æ©Ÿèƒ½ç”¨ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¸è¨˜éŒ²
  lastRates   = rates;
  lastTotals  = totals;
  lastTargets = targets;

  // ã‚µãƒãƒªãƒ¼ãƒãƒƒã‚¸
  let low = 0, ok = 0, over = 0;
  Object.values(rates).forEach(r => {
    if (r < 70) low++;
    else if (r > 130) over++;
    else ok++;
  });
  document.getElementById('summaryBadges').innerHTML = `
    <div class="badge badge-red"><div class="num">${low}</div><p>ä¸è¶³ï¼ˆ70%æœªæº€ï¼‰</p></div>
    <div class="badge badge-green"><div class="num">${ok}</div><p>è‰¯å¥½ï¼ˆ70ã€œ130%ï¼‰</p></div>
    <div class="badge badge-orange"><div class="num">${over}</div><p>éå‰°ï¼ˆ130%è¶…ï¼‰</p></div>
  `;

  renderBars(rates, totals, targets);
  renderRadar(rates);
  renderRecommendations(rates);

  document.getElementById('results').style.display = 'block';
  document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
}

function pctClass(r) {
  if (r < 70) return 'pct-low';
  if (r > 130) return 'pct-over';
  return 'pct-ok';
}
function barClass(r) {
  if (r < 70) return 'bar-low';
  if (r > 130) return 'bar-over';
  return 'bar-ok';
}

function renderBars(rates, totals, targets) {
  const container = document.getElementById('nutrientBars');
  container.innerHTML = '';
  Object.entries(NUTRIENT_META).forEach(([k, meta]) => {
    const r = rates[k] ?? 0;
    const t = targets[k];
    const v = totals[k];
    const barWidth = Math.min(r, 150);
    container.innerHTML += `
      <div class="nutrient-bar-item">
        <div class="nutrient-bar-header">
          <div>
            <span class="nutrient-name">${meta.icon} ${meta.label}</span>
            <span class="nutrient-effect">${meta.effect}</span>
          </div>
          <span class="nutrient-pct ${pctClass(r)}">${r}% (${v.toFixed(1)}/${t}${meta.unit})</span>
        </div>
        <div class="bar-bg">
          <div class="bar-fill ${barClass(r)}" style="width:${barWidth}%"></div>
        </div>
      </div>
    `;
  });
}

function renderRadar(rates) {
  const keys = ['energy','protein','fat','carb','fiber','vitA','vitD','vitC','calcium','iron','zinc','magnesium','potassium','vitB1','vitB2','vitB12'];
  const labels = keys.map(k => NUTRIENT_META[k]?.label ?? k);
  const data = keys.map(k => Math.min(rates[k] ?? 0, 150));

  if (radarChartInstance) radarChartInstance.destroy();
  const ctx = document.getElementById('radarChart').getContext('2d');
  radarChartInstance = new Chart(ctx, {
    type: 'radar',
    data: {
      labels,
      datasets: [{
        label: 'å……è¶³ç‡ï¼ˆ%ï¼‰',
        data,
        fill: true,
        backgroundColor: 'rgba(46,204,113,0.2)',
        borderColor: '#27ae60',
        borderWidth: 2,
        pointBackgroundColor: data.map(v => v < 70 ? '#e74c3c' : v > 130 ? '#f39c12' : '#27ae60'),
        pointRadius: 4,
      }, {
        label: 'æ¨å¥¨é‡ï¼ˆ100%ï¼‰',
        data: Array(keys.length).fill(100),
        fill: false,
        borderColor: '#bbb',
        borderDash: [4, 4],
        borderWidth: 1.5,
        pointRadius: 0,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          min: 0, max: 150,
          ticks: { stepSize: 50, font: { size: 9 } },
          pointLabels: { font: { size: 9 } },
          grid: { color: '#eee' },
        }
      },
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 10 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}%` } }
      }
    }
  });
}

function renderRecommendations(rates) {
  const deficient = Object.entries(rates)
    .filter(([k, r]) => r < 70 && FOOD_RECOMMENDATIONS[k])
    .sort(([,a],[,b]) => a - b);

  const el = document.getElementById('deficientList');
  if (deficient.length === 0) {
    el.innerHTML = '<p style="color:#27ae60;font-weight:700;">ğŸ‰ ã™ã¹ã¦ã®æ „é¤Šç´ ãŒ70%ä»¥ä¸Šæ‘‚ã‚Œã¦ã„ã¾ã™ï¼</p>';
    return;
  }
  el.innerHTML = deficient.map(([k, r]) => {
    const meta = NUTRIENT_META[k];
    const foods = FOOD_RECOMMENDATIONS[k];
    return `
      <div class="deficient-item">
        <h4>${meta.icon} ${meta.label}ï¼ˆå……è¶³ç‡ ${r}%ï¼‰</h4>
        <div class="tags">
          ${foods.map(f => `<span class="food-tag">${f}</span>`).join('')}
        </div>
      </div>
    `;
  }).join('');
}

// =====================================================
// ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ
// =====================================================

// é£Ÿæã®ä¸€èˆ¬çš„ãª1å˜ä½ã®é‡ã•
const FOOD_PORTIONS = {
  'ç´è±†': [{ unit: '1ãƒ‘ãƒƒã‚¯', g: 45 }, { unit: '1è¢‹ï¼ˆ3ãƒ‘ãƒƒã‚¯å…¥ã‚Šï¼‰', g: 135 }],
  'åµ': [{ unit: '1å€‹ï¼ˆMã‚µã‚¤ã‚ºï¼‰', g: 50 }, { unit: '1å€‹ï¼ˆLã‚µã‚¤ã‚ºï¼‰', g: 60 }],
  'ã”é£¯': [{ unit: '1è†³ï¼ˆæ™®é€šç››ã‚Šï¼‰', g: 150 }, { unit: '1è†³ï¼ˆå¤§ç››ã‚Šï¼‰', g: 200 }, { unit: 'èŒ¶ç¢—1æ¯ï¼ˆå°ï¼‰', g: 120 }],
  'é£Ÿãƒ‘ãƒ³': [{ unit: '1æšï¼ˆ6æšåˆ‡ã‚Šï¼‰', g: 60 }, { unit: '1æšï¼ˆ8æšåˆ‡ã‚Šï¼‰', g: 45 }],
  'ãƒãƒŠãƒŠ': [{ unit: '1æœ¬ï¼ˆçš®ãªã—ï¼‰', g: 90 }, { unit: '1æœ¬ï¼ˆçš®ã¤ãï¼‰', g: 130 }],
  'ã¿ã‹ã‚“': [{ unit: '1å€‹', g: 80 }, { unit: '1å€‹ï¼ˆå¤§ï¼‰', g: 120 }],
  'ã‚Šã‚“ã”': [{ unit: '1å€‹', g: 250 }, { unit: '1/4å€‹', g: 60 }],
  'ã‚­ã‚¦ã‚¤': [{ unit: '1å€‹', g: 80 }],
  'ã„ã¡ã”': [{ unit: '1ç²’', g: 15 }, { unit: '1ãƒ‘ãƒƒã‚¯', g: 250 }],
  'ã‚¢ãƒœã‚«ãƒ‰': [{ unit: '1å€‹ï¼ˆæ­£å‘³ï¼‰', g: 140 }],
  'é¶ã‚€ã­è‚‰': [{ unit: '1æš', g: 250 }, { unit: '1äººå‰', g: 100 }],
  'é¶ã‚‚ã‚‚è‚‰': [{ unit: '1æš', g: 250 }, { unit: '1äººå‰', g: 100 }],
  'è±šãƒ­ãƒ¼ã‚¹': [{ unit: '1æšï¼ˆç”Ÿå§œç„¼ãç”¨ï¼‰', g: 80 }, { unit: '1äººå‰', g: 100 }],
  'é®­': [{ unit: '1åˆ‡ã‚Œ', g: 100 }, { unit: '1äººå‰', g: 80 }],
  'ã¾ãã‚(èµ¤èº«)': [{ unit: 'ãŠåˆºèº«5åˆ‡ã‚Œ', g: 80 }, { unit: '1äººå‰', g: 100 }],
  'ç‰›ä¹³': [{ unit: '1æ¯ï¼ˆã‚³ãƒƒãƒ—ï¼‰', g: 200 }, { unit: '1æœ¬ï¼ˆ200mlï¼‰', g: 200 }, { unit: '1ãƒªãƒƒãƒˆãƒ«', g: 1000 }],
  'ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ': [{ unit: '1å€‹ï¼ˆå°ã‚«ãƒƒãƒ—ï¼‰', g: 80 }, { unit: '1å€‹ï¼ˆå¤§ã‚«ãƒƒãƒ—ï¼‰', g: 400 }],
  'è±†è…(æœ¨ç¶¿)': [{ unit: '1ä¸', g: 300 }, { unit: '1/3ä¸', g: 100 }],
  'ã»ã†ã‚Œã‚“è‰': [{ unit: '1æŸ', g: 200 }, { unit: '1äººå‰', g: 80 }],
  'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼': [{ unit: '1æ ª', g: 200 }, { unit: 'å°æˆ¿1å€‹', g: 20 }],
  'ã«ã‚“ã˜ã‚“': [{ unit: '1æœ¬ï¼ˆä¸­ï¼‰', g: 150 }, { unit: '1/2æœ¬', g: 75 }],
  'ãƒˆãƒãƒˆ': [{ unit: '1å€‹ï¼ˆä¸­ï¼‰', g: 150 }, { unit: 'ãƒŸãƒ‹ãƒˆãƒãƒˆ1å€‹', g: 15 }],
  'ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰': [{ unit: '10ç²’', g: 15 }, { unit: '1è¢‹ï¼ˆå°ï¼‰', g: 30 }],
  'ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«': [{ unit: '1é£Ÿåˆ†', g: 40 }, { unit: 'å¤§ã•ã˜3', g: 30 }],
  'ã¿ãæ±(1æ¯)': [{ unit: '1æ¯', g: 200 }],
  'ã‚ã•ã‚Š': [{ unit: '1ãƒ‘ãƒƒã‚¯ï¼ˆæ®»ã¤ãï¼‰', g: 150 }, { unit: 'æ­£å‘³', g: 50 }],
  'ç‰¡è £': [{ unit: '1å€‹', g: 20 }, { unit: '1äººå‰ï¼ˆ5ã€œ6å€‹ï¼‰', g: 100 }],
  'ã†ãªã': [{ unit: '1äººå‰ï¼ˆè’²ç„¼ãï¼‰', g: 100 }],
  'ãƒ¬ãƒãƒ¼(é¶)': [{ unit: '1äººå‰', g: 80 }],
  'ãƒ‘ã‚¹ã‚¿(èŒ¹ã§)': [{ unit: '1äººå‰ï¼ˆä¹¾ç‡¥80gåˆ†ï¼‰', g: 200 }],
  'ãã°(èŒ¹ã§)': [{ unit: '1äººå‰', g: 180 }],
  'ã†ã©ã‚“(èŒ¹ã§)': [{ unit: '1ç‰', g: 240 }],
  'ã²ã˜ã(ä¹¾)': [{ unit: '1é£Ÿåˆ†', g: 8 }],
  'ã‚ã‹ã‚(ç”Ÿ)': [{ unit: '1é£Ÿåˆ†', g: 30 }],
};

// æ „é¤Šç´ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé£Ÿå“DB ã‹ã‚‰å‹•çš„ã«è¨ˆç®—ï¼‰
function getRanking(nutrientKey, topN = 6) {
  return Object.entries(FOOD_DB)
    .filter(([, d]) => d[nutrientKey] > 0)
    .sort(([, a], [, b]) => b[nutrientKey] - a[nutrientKey])
    .slice(0, topN)
    .map(([name, d]) => `${name}ï¼ˆ100gã‚ãŸã‚Š ${d[nutrientKey]}${NUTRIENT_META[nutrientKey]?.unit}ï¼‰`);
}

// ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒç”¨ã®Q&Aãƒ«ãƒ¼ãƒ«
const QA_RULES = [
  // â”€â”€ é‡ã•ç³» â”€â”€
  {
    patterns: [/(.+)[ï¼ˆ(]?(\d)[ï¼‰)]?ãƒ‘ãƒƒã‚¯/, /ç´è±†.*ä½•g/, /ä½•g.*ç´è±†/],
    match: q => q.includes('ç´è±†'),
    answer: () => {
      const p = FOOD_PORTIONS['ç´è±†'];
      return `ğŸ“¦ ç´è±†ã®ç›®å®‰é‡é‡\nãƒ»${p[0].unit}ï¼šç´„${p[0].g}g\nãƒ»${p[1].unit}ï¼šç´„${p[1].g}g\n\nğŸ’¡ é£Ÿæå…¥åŠ›ã§ã¯ã€Œ45ã€gã§ã€Œ1ãƒ‘ãƒƒã‚¯åˆ†ã€ã«ãªã‚Šã¾ã™ï¼`;
    }
  },
  {
    match: q => q.includes('åµ') && (q.includes('ä½•g') || q.includes('é‡ã•') || q.includes('ä½•ã‚°ãƒ©ãƒ ') || q.includes('1å€‹')),
    answer: () => {
      const p = FOOD_PORTIONS['åµ'];
      return `ğŸ¥š åµã®ç›®å®‰é‡é‡\nãƒ»${p[0].unit}ï¼šç´„${p[0].g}g\nãƒ»${p[1].unit}ï¼šç´„${p[1].g}g\n\nğŸ’¡ æ®»ã‚’é™¤ã„ãŸæ­£å‘³é‡é‡ã§ã™ã€‚`;
    }
  },
  {
    match: q => (q.includes('ã”é£¯') || q.includes('ç™½ç±³') || q.includes('ã”ã¯ã‚“')) && (q.includes('ä½•g') || q.includes('1è†³') || q.includes('é‡ã•') || q.includes('ä½•ã‚°ãƒ©ãƒ ')),
    answer: () => {
      const p = FOOD_PORTIONS['ã”é£¯'];
      return `ğŸš ã”é£¯ã®ç›®å®‰é‡é‡\nãƒ»${p[0].unit}ï¼šç´„${p[0].g}g\nãƒ»${p[1].unit}ï¼šç´„${p[1].g}g\nãƒ»${p[2].unit}ï¼šç´„${p[2].g}g\n\nğŸ’¡ ãƒ€ã‚¤ã‚¨ãƒƒãƒˆä¸­ã¯120gï¼ˆèŒ¶ç¢—å°ç››ã‚Šï¼‰ã‚’ç›®å®‰ã«ã™ã‚‹æ–¹ã‚‚å¤šã„ã§ã™ã€‚`;
    }
  },
  {
    match: q => q.includes('ãƒãƒŠãƒŠ') && (q.includes('ä½•g') || q.includes('1æœ¬') || q.includes('é‡ã•') || q.includes('ä½•ã‚°ãƒ©ãƒ ')),
    answer: () => {
      const p = FOOD_PORTIONS['ãƒãƒŠãƒŠ'];
      return `ğŸŒ ãƒãƒŠãƒŠã®ç›®å®‰é‡é‡\nãƒ»${p[0].unit}ï¼šç´„${p[0].g}gï¼ˆé£Ÿã¹ã‚‰ã‚Œã‚‹éƒ¨åˆ†ï¼‰\nãƒ»${p[1].unit}ï¼šç´„${p[1].g}g\n\nğŸ’¡ ã‚«ãƒªã‚¦ãƒ ãŒè±Šå¯Œã§ç–²åŠ´å›å¾©ã«åŠ¹æœçš„ã§ã™ï¼`;
    }
  },
  {
    match: q => q.includes('é£Ÿãƒ‘ãƒ³') && (q.includes('ä½•g') || q.includes('1æš') || q.includes('é‡ã•') || q.includes('ä½•ã‚°ãƒ©ãƒ ')),
    answer: () => {
      const p = FOOD_PORTIONS['é£Ÿãƒ‘ãƒ³'];
      return `ğŸ é£Ÿãƒ‘ãƒ³ã®ç›®å®‰é‡é‡\nãƒ»${p[0].unit}ï¼šç´„${p[0].g}g\nãƒ»${p[1].unit}ï¼šç´„${p[1].g}g`;
    }
  },
  {
    match: q => q.includes('ç‰›ä¹³') && (q.includes('ä½•g') || q.includes('1æ¯') || q.includes('é‡ã•') || q.includes('ä½•ã‚°ãƒ©ãƒ ') || q.includes('ä½•ml')),
    answer: () => `ğŸ¥› ç‰›ä¹³ã®ç›®å®‰\nãƒ»ã‚³ãƒƒãƒ—1æ¯ï¼ˆ200mlï¼‰ï¼š200g\nãƒ»ç‰›ä¹³ã¯å¯†åº¦â‰’æ°´ãªã®ã§ ml â‰ˆ g ã§è¨ˆç®—ã§ãã¾ã™ã€‚`,
  },
  {
    match: q => q.includes('è±†è…') && (q.includes('ä½•g') || q.includes('1ä¸') || q.includes('é‡ã•') || q.includes('ä½•ã‚°ãƒ©ãƒ ')),
    answer: () => `ğŸ± è±†è…ï¼ˆæœ¨ç¶¿ãƒ»çµ¹ï¼‰ã®ç›®å®‰é‡é‡\nãƒ»1ä¸ï¼šç´„300g\nãƒ»1/3ä¸ï¼ˆ1äººå‰ç›®å®‰ï¼‰ï¼šç´„100g\nãƒ»ã‚«ãƒƒãƒˆè±†è…1ãƒ‘ãƒƒã‚¯ï¼š150ã€œ200g`,
  },

  // â”€â”€ æ±ç”¨ã€Œâ—‹â—‹ã¯ä½•gï¼Ÿã€ãƒ‘ã‚¿ãƒ¼ãƒ³ â”€â”€
  {
    match: q => {
      for (const name of Object.keys(FOOD_PORTIONS)) {
        if (q.includes(name) && (q.includes('ä½•g') || q.includes('é‡ã•') || q.includes('ä½•ã‚°ãƒ©ãƒ ') || q.includes('g?') || q.includes('gï¼Ÿ'))) return true;
      }
      return false;
    },
    answer: q => {
      for (const [name, portions] of Object.entries(FOOD_PORTIONS)) {
        if (q.includes(name)) {
          const lines = portions.map(p => `ãƒ»${p.unit}ï¼šç´„${p.g}g`).join('\n');
          return `ğŸ“¦ ${name}ã®ç›®å®‰é‡é‡\n${lines}`;
        }
      }
    }
  },

  // â”€â”€ æ „é¤Šç´ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç³» â”€â”€
  {
    match: q => q.includes('é‰„') && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('iron').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸ«€ é‰„åˆ†ãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ ãƒ“ã‚¿ãƒŸãƒ³Cã¨ä¸€ç·’ã«æ‘‚ã‚‹ã¨å¸åç‡ãŒUPã—ã¾ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('ãƒ“ã‚¿ãƒŸãƒ³C') || q.includes('ãƒ“ã‚¿ãƒŸãƒ³c') || q.includes('vitamin c')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('vitC').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸŠ ãƒ“ã‚¿ãƒŸãƒ³CãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ ç†±ã«å¼±ã„ã®ã§ç”Ÿé£Ÿã‚„çŸ­æ™‚é–“åŠ ç†±ãŒãŠã™ã™ã‚ã§ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('ã‚«ãƒ«ã‚·ã‚¦ãƒ ') || q.includes('calcium')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('calcium').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸ¥› ã‚«ãƒ«ã‚·ã‚¦ãƒ ãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ ãƒ“ã‚¿ãƒŸãƒ³Dã¨ä¸€ç·’ã«æ‘‚ã‚‹ã¨å¸åç‡ãŒUPã—ã¾ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('é£Ÿç‰©ç¹Šç¶­') || q.includes('ç¹Šç¶­')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('fiber').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸ¥¦ é£Ÿç‰©ç¹Šç¶­ãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ è…¸å†…ç’°å¢ƒã‚’æ•´ãˆã€è¡€ç³–å€¤ã®æ€¥ä¸Šæ˜‡ã‚’æŠ‘ãˆã‚‹åŠ¹æœã‚‚ã‚ã‚Šã¾ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('ã‚¿ãƒ³ãƒ‘ã‚¯è³ª') || q.includes('ãŸã‚“ã±ãè³ª') || q.includes('ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('protein').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸ¥© ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ ç­‹è‚‰ãƒ»å…ç–«ãƒ»è‚Œãªã©ä½“ã®ã‚ã‚‰ã‚†ã‚‹çµ„ç¹”ã®ææ–™ã«ãªã‚Šã¾ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('ãƒ“ã‚¿ãƒŸãƒ³D') || q.includes('ãƒ“ã‚¿ãƒŸãƒ³d')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('vitD').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `â˜€ï¸ ãƒ“ã‚¿ãƒŸãƒ³DãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ æ—¥å…‰ã«å½“ãŸã‚‹ã“ã¨ã§ã‚‚ä½“å†…ã§åˆæˆã•ã‚Œã¾ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('äºœé‰›') || q.includes('zinc')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('zinc').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸ¦ äºœé‰›ãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ å‘³è¦šãƒ»å…ç–«ãƒ»è‚Œã®å¥åº·ã«é–¢ä¿‚ã—ã¦ã„ã¾ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('ãƒã‚°ãƒã‚·ã‚¦ãƒ ') || q.includes('magnesium')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('magnesium').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸŒ° ãƒã‚°ãƒã‚·ã‚¦ãƒ ãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ ç­‹è‚‰ã®åç¸®ãƒ»ç¥çµŒæ©Ÿèƒ½ãƒ»éª¨ã®å¥åº·ã«é‡è¦ã§ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('è‘‰é…¸') || q.includes('folate')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('folate').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸ¥‘ è‘‰é…¸ãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ å¦Šå¨ åˆæœŸã«ç‰¹ã«é‡è¦ãªæ „é¤Šç´ ã§ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('ã‚«ãƒªã‚¦ãƒ ') || q.includes('potassium')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('potassium').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸŒ ã‚«ãƒªã‚¦ãƒ ãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ å¡©åˆ†ï¼ˆãƒŠãƒˆãƒªã‚¦ãƒ ï¼‰ã®æ’å‡ºã‚’åŠ©ã‘ã€è¡€åœ§ã‚’ä¸‹ã’ã‚‹åŠ¹æœãŒã‚ã‚Šã¾ã™ï¼`;
    }
  },
  {
    match: q => (q.includes('ãƒ“ã‚¿ãƒŸãƒ³A') || q.includes('ãƒ“ã‚¿ãƒŸãƒ³a')) && (q.includes('å¤šã„') || q.includes('å«ã‚€') || q.includes('ãŠã™ã™ã‚') || q.includes('é£Ÿæ') || q.includes('é£Ÿã¹ç‰©') || q.includes('è£œã†')),
    answer: () => {
      const list = getRanking('vitA').map((s,i) => `${i+1}. ${s}`).join('\n');
      return `ğŸ¥• ãƒ“ã‚¿ãƒŸãƒ³AãŒå¤šã„é£Ÿæ TOP6\n${list}\n\nğŸ’¡ ç›®ãƒ»çš®è†šãƒ»å…ç–«ã«é‡è¦ã€‚è„‚æº¶æ€§ãªã®ã§æ²¹ã¨ä¸€ç·’ã«æ‘‚ã‚‹ã¨å¸åç‡UPï¼`;
    }
  },

  // â”€â”€ ã‚«ãƒ­ãƒªãƒ¼ãƒ»æ „é¤Šæˆåˆ†ç…§ä¼š â”€â”€
  {
    match: q => {
      for (const name of Object.keys(FOOD_DB)) {
        if (q.includes(name) && (q.includes('ã‚«ãƒ­ãƒªãƒ¼') || q.includes('kcal') || q.includes('ä½•ã‚«ãƒ­ãƒªãƒ¼') || q.includes('ã‚¨ãƒãƒ«ã‚®ãƒ¼'))) return true;
      }
      return false;
    },
    answer: q => {
      for (const [name, d] of Object.entries(FOOD_DB)) {
        if (q.includes(name)) {
          return `âš¡ ${name}ã®ã‚«ãƒ­ãƒªãƒ¼ï¼ˆ100gã‚ãŸã‚Šï¼‰\nãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š${d.energy} kcal\nãƒ»ã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼š${d.protein}g\nãƒ»è„‚è³ªï¼š${d.fat}g\nãƒ»ç‚­æ°´åŒ–ç‰©ï¼š${d.carb}g\n\nğŸ’¡ é£Ÿæå…¥åŠ›æ™‚ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼`;
        }
      }
    }
  },

  // â”€â”€ ä¸€èˆ¬çš„ãªå¥åº·Q&A â”€â”€
  {
    match: q => q.includes('ç–²ã‚Œ') || q.includes('ç–²åŠ´') || q.includes('ã ã‚‹ã„'),
    answer: () => `ğŸ’ª ç–²ã‚Œã«åŠ¹ãæ „é¤Šç´ ã¨é£Ÿæ\n\nğŸŒ¾ ãƒ“ã‚¿ãƒŸãƒ³B1ï¼ˆç³–è³ªã‚’ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«å¤‰æ›ï¼‰\nâ†’ è±šè‚‰ãƒ»ç„ç±³ãƒ»æè±†\n\nğŸ«€ é‰„åˆ†ï¼ˆè²§è¡€ã«ã‚ˆã‚‹ç–²åŠ´ã‚’æ”¹å–„ï¼‰\nâ†’ ãƒ¬ãƒãƒ¼ãƒ»ã‚ã•ã‚Šãƒ»å°æ¾èœ\n\nğŸŒ° ãƒã‚°ãƒã‚·ã‚¦ãƒ ï¼ˆç­‹è‚‰ç–²åŠ´ã‚’å›å¾©ï¼‰\nâ†’ ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰ãƒ»è±†è…ãƒ»ã‚ã‹ã‚\n\nğŸ’¡ æ°´åˆ†è£œçµ¦ã‚‚å¿˜ã‚Œãšã«ï¼`,
  },
  {
    match: q => q.includes('è‚Œ') || q.includes('ç¾è‚Œ') || q.includes('ã‚¹ã‚­ãƒ³'),
    answer: () => `âœ¨ ç¾è‚Œã«åŠ¹ãæ „é¤Šç´ ã¨é£Ÿæ\n\nğŸŠ ãƒ“ã‚¿ãƒŸãƒ³Cï¼ˆã‚³ãƒ©ãƒ¼ã‚²ãƒ³ç”Ÿæˆï¼‰\nâ†’ èµ¤ãƒ‘ãƒ—ãƒªã‚«ãƒ»ã‚­ã‚¦ã‚¤ãƒ»ã„ã¡ã”\n\nğŸŒ¿ ãƒ“ã‚¿ãƒŸãƒ³Eï¼ˆæŠ—é…¸åŒ–ï¼‰\nâ†’ ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰ãƒ»ã‚¢ãƒœã‚«ãƒ‰ãƒ»ã‹ã¼ã¡ã‚ƒ\n\nğŸ¥© ã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼ˆè‚Œã®ææ–™ï¼‰\nâ†’ é¶ã‚€ã­è‚‰ãƒ»è±†è…ãƒ»åµ\n\nğŸ¥• ãƒ“ã‚¿ãƒŸãƒ³Aï¼ˆè‚Œã®ä»£è¬ï¼‰\nâ†’ ã«ã‚“ã˜ã‚“ãƒ»ã†ãªããƒ»ãƒ¬ãƒãƒ¼`,
  },
  {
    match: q => q.includes('éª¨') || q.includes('éª¨ç²—') || q.includes('å¼·ãã—'),
    answer: () => `ğŸ¦´ éª¨ã‚’å¼·ãã™ã‚‹æ „é¤Šç´ ã¨é£Ÿæ\n\nğŸ¥› ã‚«ãƒ«ã‚·ã‚¦ãƒ ï¼ˆéª¨ã®ä¸»æˆåˆ†ï¼‰\nâ†’ ç‰›ä¹³ãƒ»ãƒãƒ¼ã‚ºãƒ»å°æ¾èœãƒ»ã²ã˜ã\n\nâ˜€ï¸ ãƒ“ã‚¿ãƒŸãƒ³Dï¼ˆã‚«ãƒ«ã‚·ã‚¦ãƒ ã®å¸åã‚’åŠ©ã‘ã‚‹ï¼‰\nâ†’ é®­ãƒ»ã†ãªããƒ»ãã®ã“é¡\n\nğŸ¥¬ ãƒ“ã‚¿ãƒŸãƒ³Kï¼ˆéª¨ã«ã‚«ãƒ«ã‚·ã‚¦ãƒ ã‚’å®šç€ã•ã›ã‚‹ï¼‰\nâ†’ ç´è±†ãƒ»ã»ã†ã‚Œã‚“è‰ãƒ»ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼`,
  },
  {
    match: q => q.includes('å…ç–«') || q.includes('é¢¨é‚ª') || q.includes('ã‹ãœ'),
    answer: () => `ğŸ›¡ å…ç–«åŠ›ã‚’é«˜ã‚ã‚‹æ „é¤Šç´ ã¨é£Ÿæ\n\nğŸŠ ãƒ“ã‚¿ãƒŸãƒ³Cï¼ˆå…ç–«ç´°èƒã‚’æ´»æ€§åŒ–ï¼‰\nâ†’ èµ¤ãƒ‘ãƒ—ãƒªã‚«ãƒ»ã‚­ã‚¦ã‚¤ãƒ»ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼\n\nğŸ¦ äºœé‰›ï¼ˆå…ç–«æ©Ÿèƒ½ã®ã‚µãƒãƒ¼ãƒˆï¼‰\nâ†’ ç‰¡è £ãƒ»ç‰›èµ¤èº«ãƒ»ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰\n\nğŸ¥• ãƒ“ã‚¿ãƒŸãƒ³Aï¼ˆç²˜è†œã‚’å®ˆã‚‹ï¼‰\nâ†’ ã«ã‚“ã˜ã‚“ãƒ»ã‹ã¼ã¡ã‚ƒãƒ»ãƒ¬ãƒãƒ¼`,
  },
  {
    match: q => q.includes('ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ') || q.includes('ç—©ã›') || q.includes('æ¸›é‡') || q.includes('ä½“é‡'),
    answer: () => `ğŸƒ ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã«å½¹ç«‹ã¤çŸ¥è­˜\n\nâœ… ä½ã‚«ãƒ­ãƒªãƒ¼ã§æ „é¤Šè±Šå¯Œãªé£Ÿæ\nâ†’ é¶ã‚€ã­è‚‰ãƒ»è±†è…ãƒ»ã»ã†ã‚Œã‚“è‰ãƒ»ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼\n\nâœ… é£Ÿç‰©ç¹Šç¶­ã§æº€è…¹æ„ŸUP\nâ†’ ã”ã¼ã†ãƒ»ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«ãƒ»ãã®ã“é¡\n\nâœ… ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã§ç­‹è‚‰ã‚’ç¶­æŒ\nâ†’ åµãƒ»é­šãƒ»å¤§è±†è£½å“\n\nâš ï¸ æ¥µç«¯ãªé£Ÿäº‹åˆ¶é™ã¯æ „é¤Šä¸è¶³ã«ã¤ãªãŒã‚Šã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒªã§æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã‚’ç¢ºèªã—ãªãŒã‚‰é€²ã‚ã¾ã—ã‚‡ã†ï¼`,
  },
  {
    match: q => q.includes('è²§è¡€') || q.includes('ãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³') || q.includes('è¡€ãŒè–„'),
    answer: () => `ğŸ«€ è²§è¡€æ”¹å–„ã«åŠ¹æœçš„ãªé£Ÿæ\n\né‰„åˆ†ãŒå¤šã„é£Ÿæ\nâ†’ ãƒ¬ãƒãƒ¼ãƒ»ã‚ã•ã‚Šãƒ»ã²ã˜ããƒ»å°æ¾èœ\n\nğŸ’¡ ãƒ˜ãƒ é‰„ï¼ˆå‹•ç‰©æ€§ï¼‰ã¯å¸åç‡ãŒé«˜ã„\nâ†’ èµ¤èº«è‚‰ãƒ»é­šä»‹é¡\n\nğŸ’¡ éãƒ˜ãƒ é‰„ï¼ˆæ¤ç‰©æ€§ï¼‰ã¯ãƒ“ã‚¿ãƒŸãƒ³Cã¨ä¸€ç·’ã«\nâ†’ ã»ã†ã‚Œã‚“è‰ï¼‹ãƒ¬ãƒ¢ãƒ³ ãªã©\n\nğŸ’¡ ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ»ç´…èŒ¶ã¯é‰„ã®å¸åã‚’å¦¨ã’ã‚‹ã®ã§é£Ÿäº‹ä¸­ã¯é¿ã‘ã¦ï¼`,
  },

  // â”€â”€ ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦ â”€â”€
  {
    match: q => q.includes('ä½¿ã„æ–¹') || q.includes('ã©ã†ã‚„ã£ã¦') || (q.includes('å…¥åŠ›') && q.includes('æ–¹æ³•')),
    answer: () => `ğŸ“± ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹\n\n1ï¸âƒ£ ä¸Šéƒ¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§ã€Œæ€§åˆ¥ãƒ»å¹´é½¢ãƒ»æ´»å‹•é‡ã€ã‚’è¨­å®š\n\n2ï¸âƒ£ ã€Œæœé£Ÿ/æ˜¼é£Ÿ/å¤•é£Ÿ/é–“é£Ÿã€ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã¦é£Ÿæã‚’å…¥åŠ›\nã€€â†’ é£Ÿæåã®ã¨ã“ã‚ã«å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒå‡ºã¾ã™\nã€€â†’ é‡ã¯ã‚°ãƒ©ãƒ ï¼ˆgï¼‰ã§å…¥åŠ›\n\n3ï¸âƒ£ã€Œæ „é¤Šç´ ã‚’åˆ†æã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™\n\n4ï¸âƒ£ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã¨æ£’ã‚°ãƒ©ãƒ•ã§ä¸è¶³æ „é¤Šç´ ã‚’ç¢ºèª\n\n5ï¸âƒ£ ã€ŒãŠã™ã™ã‚é£Ÿæã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä¸è¶³ã‚’è£œã†é£Ÿæã‚’ãƒã‚§ãƒƒã‚¯ï¼`,
  },
];

function botReply(question) {
  const q = question.trim().toLowerCase()
    .replace(/[ï¼ï¼Ÿã€‚ã€]/g, '')
    .replace(/[ï½-ï½šï¼¡-ï¼º]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));

  for (const rule of QA_RULES) {
    if (rule.match(q)) {
      const ans = rule.answer(q);
      if (ans) return ans;
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé£Ÿæåã ã‘å«ã¾ã‚Œã‚‹å ´åˆ
  for (const [name, d] of Object.entries(FOOD_DB)) {
    if (q.includes(name)) {
      return `ğŸ“‹ ${name}ã®æ „é¤Šæˆåˆ†ï¼ˆ100gã‚ãŸã‚Šï¼‰\nãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š${d.energy} kcal\nãƒ»ã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼š${d.protein}g\nãƒ»è„‚è³ªï¼š${d.fat}g\nãƒ»ç‚­æ°´åŒ–ç‰©ï¼š${d.carb}g\nãƒ»é£Ÿç‰©ç¹Šç¶­ï¼š${d.fiber}g\nãƒ»ã‚«ãƒ«ã‚·ã‚¦ãƒ ï¼š${d.calcium}mg\nãƒ»é‰„ï¼š${d.iron}mg\nãƒ»ãƒ“ã‚¿ãƒŸãƒ³Cï¼š${d.vitC}mg`;
    }
  }

  // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  return `ğŸ¤” ã™ã¿ã¾ã›ã‚“ã€ãã®è³ªå•ã«ã¯ã¾ã å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nä»¥ä¸‹ã®ã‚ˆã†ãªè³ªå•ãŒå¾—æ„ã§ã™ï¼š\nãƒ»ã€Œâ—‹â—‹ã¯ä½•gï¼Ÿã€ï¼ˆé£Ÿæã®ç›®å®‰é‡é‡ï¼‰\nãƒ»ã€Œâ—‹â—‹ã®ã‚«ãƒ­ãƒªãƒ¼ã¯ï¼Ÿã€\nãƒ»ã€Œâ—‹â—‹ãŒå¤šã„é£Ÿæã¯ï¼Ÿã€ï¼ˆé‰„åˆ†ãƒ»ã‚«ãƒ«ã‚·ã‚¦ãƒ ãªã©ï¼‰\nãƒ»ã€Œç–²ã‚Œã«åŠ¹ãé£Ÿæã¯ï¼Ÿã€\nãƒ»ã€Œç¾è‚Œã«ã„ã„é£Ÿæã¯ï¼Ÿã€`;
}

function toggleChat() {
  const body = document.getElementById('chatBody');
  const icon = document.getElementById('chatToggleIcon');
  body.classList.toggle('open');
  icon.classList.toggle('open');
}

function appendMessage(text, role) {
  const messages = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  if (role === 'bot') {
    div.innerHTML = `<div class="msg-label">ğŸ¤– æ „é¤Šã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>${escapeHtml(text)}`;
  } else {
    div.innerHTML = `<div class="msg-label">ğŸ‘¤ ã‚ãªãŸ</div>${escapeHtml(text)}`;
  }
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function sendChat() {
  const input = document.getElementById('chatInput');
  const q = input.value.trim();
  if (!q) return;
  appendMessage(q, 'user');
  input.value = '';
  setTimeout(() => {
    const reply = botReply(q);
    appendMessage(reply, 'bot');
  }, 300);
}

function sendSuggestion(el) {
  document.getElementById('chatInput').value = el.textContent;
  sendChat();
}

// =====================================================
// ç›®æ¨™è¨­å®š
// =====================================================

// ç›®æ¨™åˆ¥ã®æ „é¤Šç´ è£œæ­£ä¿‚æ•°
const GOAL_SETTINGS = {
  normal:  { label: 'é€šå¸¸',        multipliers: {}, highlights: [] },
  diet:    { label: 'ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ',   multipliers: { energy: 0.8, carb: 0.7, fat: 0.8, protein: 1.2, fiber: 1.3 },
             highlights: ['fiber','protein','vitB1','vitB2'], note: 'ã‚«ãƒ­ãƒªãƒ¼20%æ¸›ãƒ»ã‚¿ãƒ³ãƒ‘ã‚¯è³ªå¢—ãƒ»é£Ÿç‰©ç¹Šç¶­å¢—ã‚’é‡è¦–' },
  muscle:  { label: 'ç­‹ãƒˆãƒ¬ãƒ»å¢—é‡', multipliers: { energy: 1.2, protein: 1.5, carb: 1.2, zinc: 1.2, magnesium: 1.2 },
             highlights: ['protein','energy','zinc','magnesium'], note: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ª50%å¢—ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼20%å¢—ã‚’é‡è¦–' },
  beauty:  { label: 'ç¾è‚Œãƒ»ç¾å®¹',   multipliers: { vitA: 1.3, vitC: 1.5, vitE: 1.3, vitB2: 1.3, zinc: 1.2, iron: 1.2 },
             highlights: ['vitA','vitC','vitE','vitB2','zinc'], note: 'ãƒ“ã‚¿ãƒŸãƒ³Aãƒ»Cãƒ»Eãƒ»äºœé‰›ãƒ»é‰„ã‚’é‡è¦–' },
  health:  { label: 'å…ç–«ãƒ»å¥åº·ç¶­æŒ',multipliers: { vitC: 1.5, vitD: 1.3, zinc: 1.3, vitA: 1.2, folate: 1.2 },
             highlights: ['vitC','vitD','zinc','vitA'], note: 'ãƒ“ã‚¿ãƒŸãƒ³Cãƒ»Dãƒ»äºœé‰›ã‚’é‡è¦–' },
  energy:  { label: 'ç–²åŠ´å›å¾©',     multipliers: { vitB1: 1.5, vitB2: 1.3, vitB6: 1.3, iron: 1.3, magnesium: 1.3 },
             highlights: ['vitB1','vitB2','vitB6','iron','magnesium'], note: 'ãƒ“ã‚¿ãƒŸãƒ³Bç¾¤ãƒ»é‰„ãƒ»ãƒã‚°ãƒã‚·ã‚¦ãƒ ã‚’é‡è¦–' },
};

let currentGoal = 'normal';

function setGoal(goal, btn) {
  currentGoal = goal;
  document.querySelectorAll('.goal-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');

  // ç›®æ¨™ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
  const setting = GOAL_SETTINGS[goal];
  let noteEl = document.getElementById('goalNote');
  if (!noteEl) {
    noteEl = document.createElement('p');
    noteEl.id = 'goalNote';
    noteEl.style.cssText = 'font-size:0.78rem;color:#8e44ad;margin-top:8px;font-weight:600;';
    document.querySelector('.goal-card').appendChild(noteEl);
  }
  noteEl.textContent = setting.note ? `ğŸ’¡ ${setting.note}` : '';
}

// ç›®æ¨™è£œæ­£ã‚’åŠ å‘³ã—ãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆå–å¾—
const _origGetTargets = getTargets;
getTargets = function() {
  const base = _origGetTargets();
  const mults = GOAL_SETTINGS[currentGoal]?.multipliers || {};
  const result = { ...base };
  Object.entries(mults).forEach(([k, m]) => {
    if (result[k] != null) result[k] = Math.round(result[k] * m);
  });
  return result;
};

// =====================================================
// ã‚ˆãä½¿ã†çŒ®ç«‹ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆï¼‰
// =====================================================

const PRESET_STORAGE_KEY = 'nutrition_presets_v1';

function loadPresets() {
  try { return JSON.parse(localStorage.getItem(PRESET_STORAGE_KEY)) || []; }
  catch { return []; }
}

function savePresetsToStorage(presets) {
  localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(presets));
}

function renderPresetChips() {
  const presets = loadPresets();
  const container = document.getElementById('presetChips');
  if (!container) return;
  container.innerHTML = presets.length === 0
    ? '<span style="font-size:0.75rem;color:#bbb;">ï¼ˆã¾ã ä¿å­˜ãªã—ï¼‰</span>'
    : presets.map((p, i) => `
        <span style="display:inline-flex;align-items:center;gap:2px;">
          <span class="preset-chip" onclick="loadPreset(${i})" title="${p.name}">${p.name}</span>
          <button class="preset-delete-btn" onclick="deletePreset(${i})" title="å‰Šé™¤">âœ•</button>
        </span>
      `).join('');
}

function savePreset() {
  saveMealInputs();
  const totalItems = Object.values(meals).flat().filter(i => i.food && i.amount).length;
  if (totalItems === 0) { alert('é£Ÿæã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„'); return; }

  const name = prompt('çŒ®ç«‹ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã„ã¤ã‚‚ã®æœé£Ÿï¼‰');
  if (!name) return;

  const presets = loadPresets();
  presets.push({ name: name.slice(0, 15), meals: JSON.parse(JSON.stringify(meals)) });
  savePresetsToStorage(presets);
  renderPresetChips();
  alert(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
}

function loadPreset(index) {
  const presets = loadPresets();
  if (!presets[index]) return;
  if (!confirm(`ã€Œ${presets[index].name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®å…¥åŠ›ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) return;
  meals = JSON.parse(JSON.stringify(presets[index].meals));
  renderMealInputs();
}

function deletePreset(index) {
  const presets = loadPresets();
  if (!confirm(`ã€Œ${presets[index].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  presets.splice(index, 1);
  savePresetsToStorage(presets);
  renderPresetChips();
}

// =====================================================
// ä¿å­˜ãƒ»ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
// =====================================================

// æœ€å¾Œã®åˆ†æçµæœã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let lastRates = null;
let lastTotals = null;
let lastTargets = null;

// analyzeNutrition() ã®çµæœã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ã«ãƒ©ãƒƒãƒ—
const _origAnalyze = analyzeNutrition;
analyzeNutrition = function() {
  _origAnalyze();
  // åˆ†æå¾Œã«ä¿å­˜ãƒãƒ¼ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
  const bar = document.querySelector('.save-bar');
  if (bar) {
    bar.style.opacity = '0';
    bar.style.transform = 'translateY(-8px)';
    setTimeout(() => {
      bar.style.transition = 'opacity 0.4s, transform 0.4s';
      bar.style.opacity = '1';
      bar.style.transform = 'translateY(0)';
    }, 100);
  }
};

// ä¿å­˜ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
function buildSaveText() {
  const sex = document.getElementById('sex').value === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
  const age = document.getElementById('ageGroup').value;
  const actMap = { low: 'ä½ã„', mid: 'ãµã¤ã†', high: 'é«˜ã„' };
  const act = actMap[document.getElementById('activity').value];
  const now = new Date();
  const dateStr = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;

  const includeMenu      = document.getElementById('chk-menu').checked;
  const includeResult    = document.getElementById('chk-result').checked;
  const includeRecommend = document.getElementById('chk-recommend').checked;

  const lines = [];
  lines.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  lines.push(`ğŸ¥— 1æ—¥ã®æ „é¤Šç´ ãƒã‚§ãƒƒã‚«ãƒ¼ã€€${dateStr}`);
  lines.push(`ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«: ${sex}ãƒ»${age}æ­³ãƒ»æ´»å‹•é‡${act}`);
  lines.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

  // çŒ®ç«‹
  if (includeMenu) {
    lines.push('');
    lines.push('ã€ä»Šæ—¥ã®çŒ®ç«‹ã€‘');
    const mealLabelMap = { breakfast: 'â˜€ æœé£Ÿ', lunch: 'ğŸŒ¤ æ˜¼é£Ÿ', dinner: 'ğŸŒ™ å¤•é£Ÿ', snack: 'ğŸµ é–“é£Ÿ' };
    let hasAnyFood = false;
    Object.entries(meals).forEach(([key, items]) => {
      const valid = items.filter(i => i.food && i.amount);
      if (valid.length === 0) return;
      hasAnyFood = true;
      lines.push(`\n${mealLabelMap[key]}`);
      valid.forEach(i => lines.push(`  ãƒ»${i.food} ${i.amount}g`));
    });
    if (!hasAnyFood) lines.push('  ï¼ˆå…¥åŠ›ãªã—ï¼‰');
  }

  // æ „é¤Šåˆ†æ
  if (includeResult && lastRates && lastTotals && lastTargets) {
    lines.push('');
    lines.push('ã€æ „é¤Šç´ åˆ†æçµæœã€‘');
    lines.push('  æ „é¤Šç´               æ‘‚å–é‡       ç›®æ¨™é‡    å……è¶³ç‡');
    lines.push('  ' + 'â”€'.repeat(46));
    Object.entries(NUTRIENT_META).forEach(([k, meta]) => {
      const r = lastRates[k] ?? 0;
      const v = lastTotals[k] ?? 0;
      const t = lastTargets[k] ?? 0;
      const flag = r < 70 ? 'âš  ä¸è¶³' : r > 130 ? 'â–² éå‰°' : 'âœ“ è‰¯å¥½';
      const name = (meta.label + 'ã€€').slice(0, 10);
      const val  = `${v.toFixed(1)}${meta.unit}`.padStart(10);
      const tgt  = `${t}${meta.unit}`.padStart(8);
      const pct  = `${r}%`.padStart(6);
      lines.push(`  ${name}  ${val}  ${tgt}  ${pct}  ${flag}`);
    });
  }

  // ãŠã™ã™ã‚é£Ÿæ
  if (includeRecommend && lastRates) {
    const deficient = Object.entries(lastRates)
      .filter(([k, r]) => r < 70 && FOOD_RECOMMENDATIONS[k])
      .sort(([,a],[,b]) => a - b);
    if (deficient.length > 0) {
      lines.push('');
      lines.push('ã€ä¸è¶³æ „é¤Šç´ ã®ãŠã™ã™ã‚é£Ÿæã€‘');
      deficient.forEach(([k, r]) => {
        const meta = NUTRIENT_META[k];
        const foods = FOOD_RECOMMENDATIONS[k].join('ãƒ»');
        lines.push(`  ${meta.icon} ${meta.label}ï¼ˆ${r}%ï¼‰`);
        lines.push(`    â†’ ${foods}`);
      });
    } else {
      lines.push('');
      lines.push('ã€ãŠã™ã™ã‚é£Ÿæã€‘');
      lines.push('  ğŸ‰ ã™ã¹ã¦ã®æ „é¤Šç´ ãŒ70%ä»¥ä¸Šæ‘‚ã‚Œã¦ã„ã¾ã™ï¼');
    }
  }

  lines.push('');
  lines.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  lines.push('â€» åšç”ŸåŠ´åƒçœã€Œæ—¥æœ¬äººã®é£Ÿäº‹æ‘‚å–åŸºæº–(2025å¹´ç‰ˆ)ã€å‚è€ƒ');
  return lines.join('\n');
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
let _saveMode = 'copy';
function openSaveModal(mode) {
  _saveMode = mode;
  const modal = document.getElementById('saveModal');
  const actions = document.getElementById('modalActions');
  const toast = document.getElementById('modalToast');
  toast.className = 'modal-toast';
  toast.textContent = '';

  if (mode === 'copy') {
    actions.innerHTML = `
      <button class="modal-btn modal-btn-cancel" onclick="closeSaveModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn modal-btn-copy" onclick="execCopy()">ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
    `;
  } else {
    actions.innerHTML = `
      <button class="modal-btn modal-btn-cancel" onclick="closeSaveModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn modal-btn-save" onclick="execDownload()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
    `;
  }
  modal.classList.add('open');
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  modal.onclick = e => { if (e.target === modal) closeSaveModal(); };
}

function closeSaveModal() {
  document.getElementById('saveModal').classList.remove('open');
}

function execCopy() {
  const text = buildSaveText();
  if (!text.trim().replace(/â”/g,'').trim()) {
    showToast('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„', false); return;
  }
  navigator.clipboard.writeText(text).then(() => {
    showToast('âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ãƒ¡ãƒ¢å¸³ãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', true);
    setTimeout(closeSaveModal, 1800);
  }).catch(() => {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', true);
    setTimeout(closeSaveModal, 1800);
  });
}

function execDownload() {
  const text = buildSaveText();
  if (!text.trim().replace(/â”/g,'').trim()) {
    showToast('ä¿å­˜ã™ã‚‹å†…å®¹ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„', false); return;
  }
  const now = new Date();
  const fname = `æ „é¤Šãƒã‚§ãƒƒã‚¯_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.txt`;
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fname;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast(`âœ… ã€Œ${fname}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`, true);
  setTimeout(closeSaveModal, 1800);
}

function showToast(msg, success) {
  const t = document.getElementById('modalToast');
  t.textContent = msg;
  t.className = 'modal-toast' + (success ? ' success' : '');
  t.style.display = 'block';
}

// =====================================================
// åˆæœŸåŒ–
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
  renderMealInputs();
  renderPresetChips();

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæœé£Ÿï¼‰
  meals.breakfast = [
    { food: 'ã”é£¯', amount: 150 },
    { food: 'åµ', amount: 50 },
    { food: 'ç‰›ä¹³', amount: 200 },
  ];
  meals.lunch = [
    { food: 'ãƒ‘ã‚¹ã‚¿(èŒ¹ã§)', amount: 200 },
    { food: 'ãƒˆãƒãƒˆ', amount: 80 },
  ];
  meals.dinner = [
    { food: 'é®­', amount: 100 },
    { food: 'ã»ã†ã‚Œã‚“è‰', amount: 80 },
    { food: 'ã”é£¯', amount: 150 },
    { food: 'ã¿ãæ±(1æ¯)', amount: 200 },
  ];
  renderMealInputs();

  // ===== Service Worker ç™»éŒ²ï¼ˆPWAå¯¾å¿œï¼‰ =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('[PWA] Service Worker ç™»éŒ²æˆåŠŸ:', reg.scope))
        .catch(err => console.log('[PWA] Service Worker ç™»éŒ²å¤±æ•—:', err));
    });
  }

  // ===== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ï¼ˆã‚¹ãƒãƒ›ã§ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ã‚’ä¿ƒã™ï¼‰ =====
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
    const banner = document.getElementById('installBanner');
    if (banner) banner.style.display = 'flex';
  });
  window.addEventListener('appinstalled', () => {
    const banner = document.getElementById('installBanner');
    if (banner) banner.style.display = 'none';
    deferredPrompt = null;
  });
  window.installApp = function() {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choice => {
        deferredPrompt = null;
        document.getElementById('installBanner').style.display = 'none';
      });
    }
  };
});
</script>
</body>
</html>
